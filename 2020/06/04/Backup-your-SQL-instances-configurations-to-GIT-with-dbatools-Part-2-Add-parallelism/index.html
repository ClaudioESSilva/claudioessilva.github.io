<!doctype html><html lang=en-us><head><script type=application/ld+json>{"@context":"http://schema.org","@type":"Website","@id":"https:\/\/claudioessilva.eu","author":{"@type":"Person","name":"Cláudio Silva","image":"https://claudioessilva.eu/img/avatar.jpg"},"name":"Cláudio Silva\u0027s Blog","description":"We have seen how we can export and save the results to a folder and commit them to a GIT repository on my last blog post Backup your SQL instances configurations to GIT with dbatools – Part 1. At the end of that post, I have mentioned that I would write about how we can lower down the execution times of our script by leveraging on parallelism.\nWhen we need to manage dozens of servers\/instances, even with automated scripts sometimes we would like that our script finishes faster.","url":"https:\/\/claudioessilva.eu\/2020\/06\/04\/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism\/","keywords":"[]"}</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.101.0 with theme Tranquilpeak 0.5.3-BETA"><meta name=author content="Cláudio Silva"><meta name=keywords content><meta name=description content="We have seen how we can export and save the results to a folder and commit them to a GIT repository on my last blog post Backup your SQL instances configurations to GIT with dbatools – Part 1. At the end of that post, I have mentioned that I would write about how we can lower down the execution times of our script by leveraging on parallelism.
When we need to manage dozens of servers/instances, even with automated scripts sometimes we would like that our script finishes faster."><meta property="og:description" content="We have seen how we can export and save the results to a folder and commit them to a GIT repository on my last blog post Backup your SQL instances configurations to GIT with dbatools – Part 1. At the end of that post, I have mentioned that I would write about how we can lower down the execution times of our script by leveraging on parallelism.
When we need to manage dozens of servers/instances, even with automated scripts sometimes we would like that our script finishes faster."><meta property="og:type" content="article"><meta property="og:title" content="Backup your SQL instances configurations to GIT with dbatools - Part 2 - Add parallelism"><meta name=twitter:title content="Backup your SQL instances configurations to GIT with dbatools - Part 2 - Add parallelism"><meta property="og:url" content="https://claudioessilva.eu/2020/06/04/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism/"><meta property="twitter:url" content="https://claudioessilva.eu/2020/06/04/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism/"><meta property="og:site_name" content="Cláudio Silva's Blog"><meta property="og:description" content="We have seen how we can export and save the results to a folder and commit them to a GIT repository on my last blog post Backup your SQL instances configurations to GIT with dbatools – Part 1. At the end of that post, I have mentioned that I would write about how we can lower down the execution times of our script by leveraging on parallelism.
When we need to manage dozens of servers/instances, even with automated scripts sometimes we would like that our script finishes faster."><meta name=twitter:description content="We have seen how we can export and save the results to a folder and commit them to a GIT repository on my last blog post Backup your SQL instances configurations to GIT with dbatools – Part 1. At the end of that post, I have mentioned that I would write about how we can lower down the execution times of our script by leveraging on parallelism.
When we need to manage dozens of servers/instances, even with automated scripts sometimes we would like that our script finishes faster."><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2020-06-04T00:00:00"><meta property="article:modified_time" content="2020-06-04T00:00:00"><meta property="article:tag" content="Automation"><meta property="article:tag" content="backup"><meta property="article:tag" content="dbatools"><meta property="article:tag" content="disaster recovery"><meta property="article:tag" content="Export"><meta property="article:tag" content="git"><meta property="article:tag" content="parallelism"><meta property="article:tag" content="PoshRSJob"><meta property="article:tag" content="PowerShell"><meta property="article:tag" content="Scripting"><meta property="article:tag" content="SQLServer"><meta property="article:tag" content="syndicated"><meta name=twitter:card content="summary"><meta name=twitter:site content="@claudioessilva"><meta name=twitter:creator content="@claudioessilva"><meta property="og:image" content="https://claudioessilva.eu/img/avatar.jpg"><meta property="twitter:image" content="https://claudioessilva.eu/img/avatar.jpg"><title>Backup your SQL instances configurations to GIT with dbatools - Part 2 - Add parallelism</title><link rel=icon href=https://claudioessilva.eu/img/favicon.jpg><link rel=canonical href=https://claudioessilva.eu/2020/06/04/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://claudioessilva.eu/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-27703765-1","auto"),ga("send","pageview"))</script></head><body><div id=blog><header id=header data-behavior=4><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=/ aria-label="Go to homepage">Cláudio Silva's Blog</a></div><a class=header-right-picture href=/#about aria-label="Open the link: /#about"><img class=header-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a></header><nav id=sidebar data-behavior=4><div class=sidebar-container><div class=sidebar-profile><a href=/#about aria-label="Read more about the author"><img class=sidebar-profile-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a><h4 class=sidebar-profile-name>Cláudio Silva</h4><h5 class=sidebar-profile-bio>Data Platform Architect and PowerShell lover.</h5></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/ title=Home><i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden=true></i>
<span class=sidebar-button-desc>Home</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/tags title=Tags><i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden=true></i>
<span class=sidebar-button-desc>Tags</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/#about title=About><i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden=true></i>
<span class=sidebar-button-desc>About</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://github.com/claudioessilva target=_blank rel=noopener title=GitHub><i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden=true></i>
<span class=sidebar-button-desc>GitHub</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://twitter.com/claudioessilva target=_blank rel=noopener title=Twitter><i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden=true></i>
<span class=sidebar-button-desc>Twitter</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://www.linkedin.com/in/claudioessilva target=_blank rel=noopener title=LinkedIn><i class="sidebar-button-icon fab fa-lg fa-linkedin" aria-hidden=true></i>
<span class=sidebar-button-desc>LinkedIn</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/index.xml title=RSS><i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden=true></i>
<span class=sidebar-button-desc>RSS</span></a></li></ul></div><div class=sidebar-container><div style=color:#ebebeb;font-size:25px;text-align:center>dbatools book</div><div style=color:#ebebeb;font-size:15px>Now available! Buy it at manning.com - 50% off with code bldbatools50</div><a href="https://www.manning.com/books/learn-dbatools-in-a-month-of-lunches?utm_source=claudioessilva&utm_medium=affiliate&utm_campaign=affiliate&a_aid=claudioessilva" target=_blank><center><img src=https://images.manning.com/264/352/resize/book/0/998b76f-982a-4661-a020-5d94909f7ea5/LeMaire-HI.png height=300></center></a></div></nav><div id=main data-behavior=4 class=hasCoverMetaIn><article class=post id=top><div class="post-header main-content-wrap text-left"><h1 class=post-title>Backup your SQL instances configurations to GIT with dbatools - Part 2 - Add parallelism</h1><div class="postShorten-meta post-meta"><time datetime=2020-06-04T00:00:00Z>June 4, 2020</time></div></div><div class="post-content markdown"><div class=main-content-wrap><p>We have seen how we can export and save the results to a folder and commit them to a GIT repository on my last blog post Backup your SQL instances configurations to GIT with dbatools – Part 1.
At the end of that post, I have mentioned that I would write about how we can lower down the execution times of our script by leveraging on parallelism.</p><p>When we need to manage dozens of servers/instances, even with automated scripts sometimes we would like that our script finishes faster.
There are multiple reasons that a sequential (one-by-one) run takes longer.
Few examples I have hit in the past:</p><p>Let me pick on this last example. <code>Export-DbaInstance</code> runs multiple <code>Export-Dba*</code> commands under the hood. This means that different queries are being run and therefore it can be faster/slower depending on the number of objects. I have a real example on this one where one instance takes more than 1 hour to generate the <code>logins.sql</code> file, however, it&rsquo;s a 100kb file which means a lot of logins/databases/permissions.</p><p>Bottom line is that your mileage may vary, but if you have thousands, hundreds or even just dozens of instances to connect, going parallel may help you by decreasing the total time needed to accomplish the task.</p><p>There are a couple of options, like the native PowerShell cmdlets <code>Start-Job</code>/<code>Stop-Job</code> a.k.a background jobs, Runspaces jobs and Thread jobs but I will just mention two of them. One is a nice addition to the most recent version of PowerShell (v7) and the other using a PowerShell module.</p><p>In case you don&rsquo;t know, with PowerShell v7 it&rsquo;s possible to use a new option <code>-Parallel</code> with <code>ForEach-Object</code>. Check PowerShell&rsquo;s team blog post PowerShell ForEach-Object Parallel Feature.</p><p>However, because I don&rsquo;t have (yet :-)) PS7, I will keep leveraging on PoshRSJob module, which uses runspaces, created by Boe Prox (T | B).
If this module is unknown to you, as a quick summary, it:</p><p>I have been using it for a long time and I&rsquo;m very happy with the results.</p><p>Just install from the PowerShell gallery with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Install-Module -Name PoshRSJob
</span></span></code></pre></div><p>or download from the Github repository.</p><p>To give a small and easy but effective example let&rsquo;s use PowerShell cmdlet <code>Test-Connection</code>.</p><p>Sequential execution:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$serverList = <span style=color:#e6db74>&#39;instance1&#39;</span>, <span style=color:#e6db74>&#39;instance2&#39;</span>, <span style=color:#e6db74>&#39;instance3&#39;</span>, <span style=color:#e6db74>&#39;instance4&#39;</span>, <span style=color:#e6db74>&#39;instance5&#39;</span>, <span style=color:#e6db74>&#39;instance6&#39;</span>, <span style=color:#e6db74>&#39;instance7&#39;</span>, <span style=color:#e6db74>&#39;instance8&#39;</span>, <span style=color:#e6db74>&#39;instance9&#39;</span>, <span style=color:#e6db74>&#39;instance10&#39;</span>
</span></span><span style=display:flex><span>$serverList | ForEach-Object { Test-Connection -ComputerName $_}
</span></span></code></pre></div><p>Took about ~32 seconds.</p><p>Using PoshRsJob to execute:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$serverList = <span style=color:#e6db74>&#39;instance1&#39;</span>, <span style=color:#e6db74>&#39;instance2&#39;</span>, <span style=color:#e6db74>&#39;instance3&#39;</span>, <span style=color:#e6db74>&#39;instance4&#39;</span>, <span style=color:#e6db74>&#39;instance5&#39;</span>, <span style=color:#e6db74>&#39;instance6&#39;</span>, <span style=color:#e6db74>&#39;instance7&#39;</span>, <span style=color:#e6db74>&#39;instance8&#39;</span>, <span style=color:#e6db74>&#39;instance9&#39;</span>, <span style=color:#e6db74>&#39;instance10&#39;</span>
</span></span><span style=display:flex><span>$serverList | Start-RSJob -ScriptBlock {Test-Connection -ComputerName $_} | Wait-RSJob | Receive-RSJob
</span></span><span style=display:flex><span><span style=color:#75715e># To clean-up</span>
</span></span><span style=display:flex><span>Get-RsJob | Remove-RsJob
</span></span></code></pre></div><p>This execution took about ~6 seconds. This translates in a 7 times faster execution!</p><p>Just to explain the code:</p><p>There is an explanation</p><p>On the small description that I have shared about the PoshRsJob it says:</p><p>Although we haven&rsquo;t specified this parameter, the parallelism kicked anyway. That happened because a value of 5 is being used by default.</p><p>There are multiple factors to keep in mind when selecting a value for <code>-Throttle</code>.</p><p>It will depend on your available CPU (number of cores)/memory on the server where you are running the script.</p><p>But, It also depends on the type of script that you are running.</p><p>If you have a script that will try to find one file on one disk recursively, we may think that parallelism can be helpful to make it faster, however, the disk is the same and therefore we can hit an I/O bottleneck.
On the other hand, if we are trying to find the file on different disks we can parallelize and have one runspace running on each disk avoiding the I/O bottleneck and getting better results.</p><p>Another example is the one mentioned on the &ldquo;When should it be avoided?&rdquo; section of the earlier mentioned PowerShell v7 - Parallel blog post, if your script is trivial adding the parallelism can actually make it much slower!</p><p>That said, I have scripts where I use 10 but others where I use 15.</p><p>You need to test. Start with the default of 5, then increase this number and document the total execution time. Try to find your tipping-point and keep that number. Revisit them to adjust whenever needed.</p><p>Let&rsquo;s have an idea on how much time it takes when leveraging on <code>-Throttle 10</code>:
Using PoshRsJob to execute:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$serverList = <span style=color:#e6db74>&#39;instance1&#39;</span>, <span style=color:#e6db74>&#39;instance2&#39;</span>, <span style=color:#e6db74>&#39;instance3&#39;</span>, <span style=color:#e6db74>&#39;instance4&#39;</span>, <span style=color:#e6db74>&#39;instance5&#39;</span>, <span style=color:#e6db74>&#39;instance6&#39;</span>, <span style=color:#e6db74>&#39;instance7&#39;</span>, <span style=color:#e6db74>&#39;instance8&#39;</span>, <span style=color:#e6db74>&#39;instance9&#39;</span>, <span style=color:#e6db74>&#39;instance10&#39;</span>
</span></span><span style=display:flex><span>$serverList | Start-RSJob -ScriptBlock {Test-Connection -ComputerName $_} -Throttle 10 | Wait-RSJob | Receive-RSJob
</span></span><span style=display:flex><span><span style=color:#75715e># To clean-up</span>
</span></span><span style=display:flex><span>Get-RsJob | Remove-RsJob
</span></span></code></pre></div><p>Took about ~3 seconds.</p><p>Cool stuff!</p><p>Now that you have an idea on how it works we can start using our dbatools&rsquo; commands.</p><p>The PoshRsJob uses runspaces. Trying to simplify the explanation, think about each runspace as a PowerShell session on its own.</p><p>This means when we run a command using the <code>Start-RSjob</code> we have 5 (by default) sessions running, each one of these sessions will need to import dbatools module.</p><p>Note: There is a <code>-ModulesToImport</code> parameter however, in my previous tests this hasn&rsquo;t made any big difference.</p><p>Sequential execution:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$serverList = <span style=color:#e6db74>&#39;instance1&#39;</span>, <span style=color:#e6db74>&#39;instance2&#39;</span>, <span style=color:#e6db74>&#39;instance3&#39;</span>, <span style=color:#e6db74>&#39;instance4&#39;</span>, <span style=color:#e6db74>&#39;instance5&#39;</span>
</span></span><span style=display:flex><span>$serverList | Test-DbaConnection
</span></span></code></pre></div><p>Execution with PoshRsJob:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$serverList = <span style=color:#e6db74>&#39;instance1&#39;</span>, <span style=color:#e6db74>&#39;instance2&#39;</span>, <span style=color:#e6db74>&#39;instance3&#39;</span>, <span style=color:#e6db74>&#39;instance4&#39;</span>, <span style=color:#e6db74>&#39;instance5&#39;</span>
</span></span><span style=display:flex><span>$serverList | Start-RSJob -ScriptBlock {Test-DbaConnection $_} | Wait-RSJob | Receive-RSJob
</span></span><span style=display:flex><span><span style=color:#75715e># To clean-up</span>
</span></span><span style=display:flex><span>Get-RsJob | Remove-RSJob
</span></span></code></pre></div><p>I have also run for 10 and 20 instances. Here are the results:</p><p>Note: I have used cold cache (started a new session).
Note2: On my test server the module load takes ~23 seconds</p><p>In the final script you will see that I have created a variable <code>$sb</code> which stands for &lsquo;script block&rsquo; this way, the code is more readable.
Also, I&rsquo;m passing to parameters using <code>-ArgumentList</code> parameter which accepts an array of values. This means that inside the script block the:</p><p>Copy and save the script within your repository folder and change the following variables:</p><p>The main block change appears between line 36 and 54.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Where we will get the list of servers</span>
</span></span><span style=display:flex><span>$centralServer = <span style=color:#e6db74>&#34;centralServer&#34;</span>
</span></span><span style=display:flex><span>$centralDatabase = <span style=color:#e6db74>&#34;centralDatabase&#34;</span>
</span></span><span style=display:flex><span>$query = <span style=color:#e6db74>&#34;SELECT ConnString FROM &lt;table&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># number of parallel executions using PoshRsJob module</span>
</span></span><span style=display:flex><span>$throttle = 5
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get the list of servers</span>
</span></span><span style=display:flex><span>$ServerList = Invoke-DbaQuery -SqlInstance $centralServer -Database $centralDatabase -Query $query | Select-Object -ExpandProperty ConnString
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$instancesPath = <span style=color:#e6db74>&#34;$PSScriptRoot\Instances&#34;</span>
</span></span><span style=display:flex><span>$tempPath = <span style=color:#e6db74>&#34;$instancesPath\temp&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Change location to be able to run GIT commands on the local repository</span>
</span></span><span style=display:flex><span>Set-Location -Path $PSScriptRoot
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># get folder up-to-date</span>
</span></span><span style=display:flex><span>git pull
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create/clear temp folder</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (Test-Path -Path $tempPath) {
</span></span><span style=display:flex><span>    <span style=color:#75715e># Clean the folder</span>
</span></span><span style=display:flex><span>    Get-ChildItem $tempPath | Remove-Item -Force -Recurse -Confirm<span style=color:#960050;background-color:#1e0010>:</span>$false
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    $null = New-Item -Path $tempPath -ItemType Directory
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;#
</span></span></span><span style=display:flex><span><span style=color:#75715e>    Databases -&gt; Exclude databases will not script the RESTORE statements for last backup. We don&#39;t need this because we use a 3rd party tool and this was slowing down the execution
</span></span></span><span style=display:flex><span><span style=color:#75715e>    PolicyManagement and ReplicationSettings -&gt; We don&#39;t use
</span></span></span><span style=display:flex><span><span style=color:#75715e>    Credentials and LinkedServers -&gt; We script as a second step to hide passwords (because -ExcludePassword will also hide hashed ones from logins, and this we want to keep)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#&gt;</span>
</span></span><span style=display:flex><span>$excludeObjects = <span style=color:#e6db74>&#34;Databases&#34;</span>, <span style=color:#e6db74>&#34;PolicyManagement&#34;</span>, <span style=color:#e6db74>&#34;ReplicationSettings&#34;</span>, <span style=color:#e6db74>&#34;Credentials&#34;</span>, <span style=color:#e6db74>&#34;LinkedServers&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$sb = {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>param</span> (
</span></span><span style=display:flex><span>        $ppath
</span></span><span style=display:flex><span>        ,$pexcludeObjects
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#75715e># Run the export and get a collection of files generated</span>
</span></span><span style=display:flex><span>    $outputDirectory = Export-DbaInstance -SqlInstance $_ -Path $ppath -Exclude $pexcludeObjects -NoPrefix
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Extract the directory full path of the export to use next</span>
</span></span><span style=display:flex><span>    $instanceOutDir = $outputDirectory.Directory | Select-Object -ExpandProperty FullName -Unique
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Export credentials and LinkedServers but excluding the password. Output to same folder</span>
</span></span><span style=display:flex><span>    Export-DbaCredential -SqlInstance $_ -FilePath <span style=color:#e6db74>&#34;$instanceOutDir\Credentials.sql&#34;</span> -ExcludePassword
</span></span><span style=display:flex><span>    Export-DbaLinkedServer -SqlInstance $_ -FilePath <span style=color:#e6db74>&#34;$instanceOutDir\LinkedServers.sql&#34;</span> -ExcludePassword
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>$ServerList | Start-RSJob -ScriptBlock $sb -Throttle $throttle -ArgumentList $tempPath, $excludeObjects
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Wait for the parallel job finish and remove them</span>
</span></span><span style=display:flex><span>Get-RSJob | Wait-RSJob | Remove-RSJob
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Find .sql files where the name starts with a number and rename files to exclude numeric part &#34;#-&lt;NAME&gt;.sql&#34; (remove the &#34;#-&#34;)</span>
</span></span><span style=display:flex><span>Get-ChildItem -Path $tempPath -Recurse -Filter <span style=color:#e6db74>&#34;*.sql&#34;</span> | Where {$_.Name <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#39;^[0-9]+.*&#39;</span>} | Foreach-Object {Rename-Item -Path $_.FullName -NewName $($_ -split <span style=color:#e6db74>&#39;-&#39;</span>)[1] -Force}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Remove the suffix &#34;-datetime&#34;</span>
</span></span><span style=display:flex><span>Get-ChildItem -Path $tempPath | Foreach-Object {Rename-Item -Path $_.FullName -NewName $_.Name.Substring(0, $_.Name.LastIndexOf(<span style=color:#e6db74>&#39;-&#39;</span>)) -Force}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Copy the folders/files from the temp directory to one level up (overwrite)</span>
</span></span><span style=display:flex><span>Copy-Item -Path <span style=color:#e6db74>&#34;$tempPath\*&#34;</span> -Destination $instancesPath -Recurse -Force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Clean-up temp folder</span>
</span></span><span style=display:flex><span>Get-ChildItem $tempPath | Remove-Item -Force -Recurse -Confirm<span style=color:#960050;background-color:#1e0010>:</span>$false
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add/commit/push the changes</span>
</span></span><span style=display:flex><span>git add .
</span></span><span style=display:flex><span>git commit -m <span style=color:#e6db74>&#34;Export-DbaInstance @ </span>$((Get-Date).ToString(<span style=color:#e6db74>&#34;yyyyMMdd-HHmmss&#34;</span>))<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>git push
</span></span></code></pre></div><p>Just to give an idea of the differences, for the exact same 5 instances running the script from part 1 or running this one leads to this execution times</p><p>Pretty cool right? :-)</p><p>I have shared the PoshRsJob module which makes it possible to run code in parallel. On my tests, we can see almost 50% cut-off on the execution times, and this was just for 5 instances.</p><p>Again, I hope this gives you, at least, a good starting point to decrease the total execution times for your processes.
Test with different commands and leverage on the beauty of the parallelism!</p><p>If you are curious about a comparison between both approaches, you can read the blog post PowerShell7 Foreach Parallel from Josh King (T | B) does a comparison between this new feature and the PoshRSJob module.</p><p>Also, Nasir Zubair (T | B) back in 2018 wrote about all of them (excluding -Parallel which was not a thing at the time) on the PowerShell - Background jobs, runspace jobs, thread jobs blog post.</p><p>Thanks for reading!</p></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-footer-tags><span class="text-color-light text-small">TAGGED IN</span><br><a class="tag tag--primary tag--small" href=/tags/Automation/>Automation</a>
<a class="tag tag--primary tag--small" href=/tags/backup/>backup</a>
<a class="tag tag--primary tag--small" href=/tags/dbatools/>dbatools</a>
<a class="tag tag--primary tag--small" href=/tags/disaster-recovery/>disaster recovery</a>
<a class="tag tag--primary tag--small" href=/tags/Export/>Export</a>
<a class="tag tag--primary tag--small" href=/tags/git/>git</a>
<a class="tag tag--primary tag--small" href=/tags/parallelism/>parallelism</a>
<a class="tag tag--primary tag--small" href=/tags/PoshRSJob/>PoshRSJob</a>
<a class="tag tag--primary tag--small" href=/tags/PowerShell/>PowerShell</a>
<a class="tag tag--primary tag--small" href=/tags/Scripting/>Scripting</a>
<a class="tag tag--primary tag--small" href=/tags/SQLServer/>SQLServer</a>
<a class="tag tag--primary tag--small" href=/tags/syndicated/>syndicated</a></div><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2020/06/09/TSQL-Tuesday-#127-Non-SQL-Tips-and-Tricks-Windows/ data-tooltip="TSQL Tuesday #127 - Non SQL Tips and Tricks - Windows" aria-label="NEXT: TSQL Tuesday #127 - Non SQL Tips and Tricks - Windows"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2020/06/02/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-1/ data-tooltip="Backup your SQL instances configurations to GIT with dbatools - Part 1" aria-label="PREVIOUS: Backup your SQL instances configurations to GIT with dbatools - Part 1"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2020/06/04/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2020/06/04/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2020/06/04/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div><div class=comments><script src=https://utteranc.es/client.js repo=ClaudioESSilva/blog-comments issue-term=og:title theme=github-light crossorigin=anonymous async></script></div></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2022 Cláudio Silva. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=4><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2020/06/09/TSQL-Tuesday-#127-Non-SQL-Tips-and-Tricks-Windows/ data-tooltip="TSQL Tuesday #127 - Non SQL Tips and Tricks - Windows" aria-label="NEXT: TSQL Tuesday #127 - Non SQL Tips and Tricks - Windows"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2020/06/02/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-1/ data-tooltip="Backup your SQL instances configurations to GIT with dbatools - Part 1" aria-label="PREVIOUS: Backup your SQL instances configurations to GIT with dbatools - Part 1"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2020/06/04/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2020/06/04/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2020/06/04/Backup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div></div><div id=share-options-bar class=share-options-bar data-behavior=4><i id=btn-close-shareoptions class="fa fa-times"></i><ul class=share-options><li class=share-option><a class=share-option-btn target=new href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fclaudioessilva.eu%2F2020%2F06%2F04%2FBackup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism%2F" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i><span>Share on Facebook</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fclaudioessilva.eu%2F2020%2F06%2F04%2FBackup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism%2F" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i><span>Share on Twitter</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fclaudioessilva.eu%2F2020%2F06%2F04%2FBackup-your-SQL-instances-configurations-to-GIT-with-dbatools-Part-2-Add-parallelism%2F" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i><span>Share on Linkedin</span></a></li></ul></div><div id=share-options-mask class=share-options-mask></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-times"></i></div><img id=about-card-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"><h4 id=about-card-name>Cláudio Silva</h4><div id=about-card-bio>Data Platform Architect and PowerShell lover.</div><div id=about-card-job><i class="fa fa-briefcase"></i><br>Data Platform Architect</div><div id=about-card-location><i class="fa fa-map-marker-alt"></i><br>Portugal</div></div></div><div id=cover style=background-image:url(https://claudioessilva.eu/images/cover_bridge.jpg)></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://claudioessilva.eu/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js></script>
<script>$(document).ready(function(){hljs.configure({classPrefix:"",useBR:!1}),$("pre.code-highlight > code, pre > code").each(function(e,t){$(this).hasClass("codeblock")||$(this).addClass("codeblock"),hljs.highlightBlock(t)})})</script></body></html>