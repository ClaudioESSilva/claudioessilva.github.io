<!doctype html><html lang=en-us><head><script type=application/ld+json>{"@context":"http://schema.org","@type":"Website","@id":"https:\/\/claudioessilva.eu","author":{"@type":"Person","name":"Cláudio Silva","image":"https://claudioessilva.eu/img/avatar.jpg"},"name":"Cláudio Silva\u0027s Blog","description":"This was initial posted on SQL Server Central articles.\nAs one of dbatools\u0026rsquo; first members, I\u0026rsquo;ve been using it for years and it\u0026rsquo;s really my goto tool. This task was no different!\nToday\u0026rsquo;s tip and trick using dbatools is about generating an Excel workbook that contains lists of SQL Server roles and its members.\nThe Usefulness of these Reports These reports are especially useful when performing tech-refreshes (migrating from an old version to a newer one) and you want to do some housekeeping.","url":"https:\/\/claudioessilva.eu\/2020\/07\/31\/Generate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules\/","keywords":"[]"}</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.101.0 with theme Tranquilpeak 0.5.3-BETA"><meta name=author content="Cláudio Silva"><meta name=keywords content><meta name=description content="This was initial posted on SQL Server Central articles.
As one of dbatools&rsquo; first members, I&rsquo;ve been using it for years and it&rsquo;s really my goto tool. This task was no different!
Today&rsquo;s tip and trick using dbatools is about generating an Excel workbook that contains lists of SQL Server roles and its members.
The Usefulness of these Reports These reports are especially useful when performing tech-refreshes (migrating from an old version to a newer one) and you want to do some housekeeping."><meta property="og:description" content="This was initial posted on SQL Server Central articles.
As one of dbatools&rsquo; first members, I&rsquo;ve been using it for years and it&rsquo;s really my goto tool. This task was no different!
Today&rsquo;s tip and trick using dbatools is about generating an Excel workbook that contains lists of SQL Server roles and its members.
The Usefulness of these Reports These reports are especially useful when performing tech-refreshes (migrating from an old version to a newer one) and you want to do some housekeeping."><meta property="og:type" content="article"><meta property="og:title" content="Generate SQL Server Role Member Reports using dbatools and ImportExcel PowerShell modules"><meta name=twitter:title content="Generate SQL Server Role Member Reports using dbatools and ImportExcel PowerShell modules"><meta property="og:url" content="https://claudioessilva.eu/2020/07/31/Generate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules/"><meta property="twitter:url" content="https://claudioessilva.eu/2020/07/31/Generate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules/"><meta property="og:site_name" content="Cláudio Silva's Blog"><meta property="og:description" content="This was initial posted on SQL Server Central articles.
As one of dbatools&rsquo; first members, I&rsquo;ve been using it for years and it&rsquo;s really my goto tool. This task was no different!
Today&rsquo;s tip and trick using dbatools is about generating an Excel workbook that contains lists of SQL Server roles and its members.
The Usefulness of these Reports These reports are especially useful when performing tech-refreshes (migrating from an old version to a newer one) and you want to do some housekeeping."><meta name=twitter:description content="This was initial posted on SQL Server Central articles.
As one of dbatools&rsquo; first members, I&rsquo;ve been using it for years and it&rsquo;s really my goto tool. This task was no different!
Today&rsquo;s tip and trick using dbatools is about generating an Excel workbook that contains lists of SQL Server roles and its members.
The Usefulness of these Reports These reports are especially useful when performing tech-refreshes (migrating from an old version to a newer one) and you want to do some housekeeping."><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2020-07-31T00:00:00"><meta property="article:modified_time" content="2020-07-31T00:00:00"><meta property="article:tag" content="Automation"><meta property="article:tag" content="dbatools"><meta property="article:tag" content="Export"><meta property="article:tag" content="Permissions"><meta property="article:tag" content="PowerShell"><meta property="article:tag" content="roles"><meta property="article:tag" content="Scripting"><meta property="article:tag" content="Security"><meta property="article:tag" content="SQLServer"><meta property="article:tag" content="syndicated"><meta name=twitter:card content="summary"><meta name=twitter:site content="@claudioessilva"><meta name=twitter:creator content="@claudioessilva"><meta property="og:image" content="https://claudioessilva.eu/img/avatar.jpg"><meta property="twitter:image" content="https://claudioessilva.eu/img/avatar.jpg"><title>Generate SQL Server Role Member Reports using dbatools and ImportExcel PowerShell modules</title><link rel=icon href=https://claudioessilva.eu/img/favicon.jpg><link rel=canonical href=https://claudioessilva.eu/2020/07/31/Generate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://claudioessilva.eu/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-27703765-1","auto"),ga("send","pageview"))</script></head><body><div id=blog><header id=header data-behavior=4><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=/ aria-label="Go to homepage">Cláudio Silva's Blog</a></div><a class=header-right-picture href=/#about aria-label="Open the link: /#about"><img class=header-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a></header><nav id=sidebar data-behavior=4><div class=sidebar-container><div class=sidebar-profile><a href=/#about aria-label="Read more about the author"><img class=sidebar-profile-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a><h4 class=sidebar-profile-name>Cláudio Silva</h4><h5 class=sidebar-profile-bio>Data Platform Architect and PowerShell lover.</h5></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/ title=Home><i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden=true></i>
<span class=sidebar-button-desc>Home</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/tags title=Tags><i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden=true></i>
<span class=sidebar-button-desc>Tags</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/#about title=About><i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden=true></i>
<span class=sidebar-button-desc>About</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://github.com/claudioessilva target=_blank rel=noopener title=GitHub><i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden=true></i>
<span class=sidebar-button-desc>GitHub</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://twitter.com/claudioessilva target=_blank rel=noopener title=Twitter><i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden=true></i>
<span class=sidebar-button-desc>Twitter</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://www.linkedin.com/in/claudioessilva target=_blank rel=noopener title=LinkedIn><i class="sidebar-button-icon fab fa-lg fa-linkedin" aria-hidden=true></i>
<span class=sidebar-button-desc>LinkedIn</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/index.xml title=RSS><i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden=true></i>
<span class=sidebar-button-desc>RSS</span></a></li></ul></div><div class=sidebar-container><div style=color:#ebebeb;font-size:25px;text-align:center>dbatools book</div><div style=color:#ebebeb;font-size:15px>Now available! Buy it at manning.com - 50% off with code bldbatools50</div><a href="https://www.manning.com/books/learn-dbatools-in-a-month-of-lunches?utm_source=claudioessilva&utm_medium=affiliate&utm_campaign=affiliate&a_aid=claudioessilva" target=_blank><center><img src=https://images.manning.com/264/352/resize/book/0/998b76f-982a-4661-a020-5d94909f7ea5/LeMaire-HI.png height=300></center></a></div></nav><div id=main data-behavior=4 class=hasCoverMetaIn><article class=post id=top><div class="post-header main-content-wrap text-left"><h1 class=post-title>Generate SQL Server Role Member Reports using dbatools and ImportExcel PowerShell modules</h1><div class="postShorten-meta post-meta"><time datetime=2020-07-31T00:00:00Z>July 31, 2020</time></div></div><div class="post-content markdown"><div class=main-content-wrap><blockquote><p>This was initial posted on <a href=https://www.sqlservercentral.com/articles/generate-role-member-reports-using-dbatools-and-the-importexcel-powershell-modules>SQL Server Central articles</a>.</p></blockquote><p>As one of dbatools&rsquo; first members, I&rsquo;ve been using it for years and it&rsquo;s really my goto tool. This task was no different!</p><p>Today&rsquo;s tip and trick using <a href=https://dbatools.io>dbatools</a> is about generating an Excel workbook that contains lists of SQL Server roles and its members.</p><h2 id=the-usefulness-of-these-reports>The Usefulness of these Reports</h2><p>These reports are especially useful when performing tech-refreshes (migrating from an old version to a newer one) and you want to do some housekeeping. For example, finding logins that should be part of a role and they are not. Once you know there are problems, you decided to do a double-check on the whole list.</p><p>Excel makes these reports even better because they can be used to sort/filter large amounts of data: instances, roles and logins. Excel also makes the any data manipulation it easier when editing, marking members to be deleted, or highlighting issues when working with other teams.</p><h2 id=doing-it-manually>Doing it manually?</h2><p>I would like you to think about how much time you would need to:</p><p>I would say more time than you would like. Doing this manually needs way too many clicks and keystrokes for something that we can be using daily.</p><h2 id=back-on-track-what-will-we-get>Back on track, what will we get?</h2><p>The output will be an Excel (xlsx) file that will have multiple spreadsheets. In my case those are:</p><h2 id=what-does-the-output-look-like>What does the output look like?</h2><p>Here is a sneak-peak of the result that you will see right after opening the file.</p><p>The formatted table with headers, filters and top freeze-row will be there too!</p><h2 id=prerequisites>Prerequisites</h2><p>To accomplish this we will write a PowerShell script and for that, we will using commands from two PowerShell modules.</p><p><a href=https://dbatools.io>dbatools</a></p><p>And on top of this, you should know that it counts with more than 500 commands.</p><p>The other module is <a href=https://github.com/dfinke/ImportExcel>ImportExcel</a>, created by Doug Finke (<a href=https://twitter.com/dfinke>T</a> | <a href=https://dfinke.github.io/>B</a>)</p><p>&ldquo;&mldr;without installing Microsoft Excel&mldr;&rdquo; - How cool is that?!</p><h3 id=how-to-install-the-modules>How to install the modules</h3><p>You can run the following command and both modules will be downloaded to your machine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Install-Module -Name dbatools, ImportExcel
</span></span></code></pre></div><p>If you don&rsquo;t have admin privileges on the machine you can use <code>-Scope CurrentUser</code> to get the modules installed under your profile.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Install-Module -Name dbatools, ImportExcel -Scope CurrentUser
</span></span></code></pre></div><h2 id=dbatools-commands-to-use>dbatools&rsquo; commands to use</h2><p>You can use <a href=https://docs.dbatools.io>docs.dbatools.io</a> to search for a command. Or, if you are in an offline environment, you can use the <code>Find-DbaCommand</code>.</p><p>For instance, because we are talking about logins, I would run the following command to search for dbatools commands that have the <code>-Tag Login</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Find-DbaCommand -Tag Login
</span></span></code></pre></div><p>The dbatools&rsquo; team has tagged all these (+20) commands as to be related with logins.</p><p>Taking a closer look, we can see some <code>Get-</code> commands and from those, we will use:</p><h3 id=get-dbalogin>Get-DbaLogin</h3><p>Getting the list of all logins on the instance is as easy as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-DbaLogin -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span>
</span></span></code></pre></div><p>Since we may want to share this list with the client, I suggest to filter out some logins that will not be useful, or perhaps worse, these logins will confuse the client. I&rsquo;m talking about your &lsquo;renamedSA&rsquo; account, all the Windows users starting with ‘NT *&rsquo;, or other logins that belong to you or your team and the client does not need to be aware of them.</p><h3 id=filtering>Filtering</h3><p>With the Get-DbaLogin command, we have two types of filters. One way is to filter by an exact login name (for example &ldquo;renamedSA&rdquo;). For that, we need to use the <code>-ExcludeLogin</code> parameter. The other way is using the <code>-ExcludeFilter</code>. This one is very handy, as it accepts wildcards patterns. This means that we can filter out all the logins that start with “NT ” by passing the value &ldquo;NT *&rdquo;. You can add multiple patterns by splitting the list with a comma. <code>-ExcludeFilter "NT *", "##*"</code></p><p>Using these parameters, I can run this command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-DbaLogin -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -ExcludeLogin <span style=color:#e6db74>&#34;renamedSA&#34;</span> -ExcludeFilter <span style=color:#e6db74>&#34;NT *&#34;</span>, <span style=color:#e6db74>&#34;##*&#34;</span>
</span></span></code></pre></div><h3 id=get-dbaserverrolemember>Get-DbaServerRoleMember</h3><p>This cmdlet will get the list of all members for all server roles:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-DbaServerRoleMember -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span>
</span></span></code></pre></div><p>We want to keep this consistent with the previous command. If we filtered out logins before, we will have to filter them here as well. In this case, this command has a <code>-Login</code> parameter where we can specify a list of logins that we want to process.</p><p>We can leverage from the previous <code>Get-DbaLogin</code> command output to get the login&rsquo;s names and pass them to the <code>-Login</code> parameter as <code>$logins.Name</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Get all logins to analyse</span>
</span></span><span style=display:flex><span>$logins = Get-DbaLogin -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -ExcludeLogin <span style=color:#e6db74>&#34;renamedSA&#34;</span> -ExcludeFilter <span style=color:#e6db74>&#34;NT *&#34;</span>, <span style=color:#e6db74>&#34;##*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get just for the logins we want</span>
</span></span><span style=display:flex><span>Get-DbaServerRoleMember -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -Login $logins.Name
</span></span></code></pre></div><p>We can also use the <code>-ExcludeDatabase</code> parameter to filter out some databases we don&rsquo;t want to get the data from.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Get all logins to analyse</span>
</span></span><span style=display:flex><span>$logins = Get-DbaLogin -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -ExcludeLogin <span style=color:#e6db74>&#34;renamedSA&#34;</span> -ExcludeFilter <span style=color:#e6db74>&#34;NT *&#34;</span>, <span style=color:#e6db74>&#34;##*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get just for the logins we want</span>
</span></span><span style=display:flex><span>Get-DbaServerRoleMember -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -ExcludeDatabase <span style=color:#e6db74>&#34;myDB&#34;</span> -Login $logins.Name
</span></span></code></pre></div><h3 id=get-dbadbrolemember>Get-DbaDbRoleMember</h3><p>This will get us a list of all members for all databases and all their roles:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-DbaDbRoleMember -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span>
</span></span></code></pre></div><p>Here we can, again, leverage from the previous <code>Get-DbaLogin</code> command output to get the login&rsquo;s names and use them to filter the ones we want. But in this case, we don&rsquo;t have any input parameter to pass this list. This means that, we will need to pass the values through the pipeline and filter using the <code>Where-Object</code> cmdlet.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Get all logins to analyse</span>
</span></span><span style=display:flex><span>$logins = Get-DbaLogin -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -ExcludeLogin <span style=color:#e6db74>&#34;renamedSA&#34;</span> -ExcludeFilter <span style=color:#e6db74>&#34;NT *&#34;</span>, <span style=color:#e6db74>&#34;##*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get just for the logins we want</span>
</span></span><span style=display:flex><span>Get-DbaDbRoleMember -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> | Where-Object UserName -in $logins.Name
</span></span></code></pre></div><p>This command also has the <code>-ExcludeDatabase</code> parameter available.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Get all logins to analyse</span>
</span></span><span style=display:flex><span>$logins = Get-DbaLogin -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -ExcludeLogin <span style=color:#e6db74>&#34;renamedSA&#34;</span> -ExcludeFilter <span style=color:#e6db74>&#34;NT *&#34;</span>, <span style=color:#e6db74>&#34;##*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get just for the logins we want</span>
</span></span><span style=display:flex><span>Get-DbaDbRoleMember -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -ExcludeDatabase <span style=color:#e6db74>&#34;myDB&#34;</span> | Where-Object UserName -in $logins.Name
</span></span></code></pre></div><p>These are the three dbatools’ commands that we will be using to get our data. Let’s see what we need from the &lsquo;ImportExcel&rsquo; module.</p><h2 id=importexcel-command>ImportExcel command</h2><p>With the results, all there’s left to do is to output them to a nice Excel spreadsheet. For that, we just need to pipe our results to the <code>Export-Excel</code> command.</p><p>You should explore all the available parameter on this command, however, I will share the ones we will use on this script:</p><p>This means that we can call the <code>Export-Excel</code> command in the following way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Get all logins to analyse</span>
</span></span><span style=display:flex><span>$logins = Get-DbaLogin -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -ExcludeLogin <span style=color:#e6db74>&#34;renamedSA&#34;</span> -ExcludeFilter <span style=color:#e6db74>&#34;NT *&#34;</span>, <span style=color:#e6db74>&#34;##*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get just for the logins we want</span>
</span></span><span style=display:flex><span>$dbRoleMembers = Get-DbaDbRoleMember -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> | Where-Object UserName -in $logins.Name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Splatting the parameters</span>
</span></span><span style=display:flex><span>$excelDBRoleMembersOutput = @{
</span></span><span style=display:flex><span>    Path = <span style=color:#e6db74>&#34;D:\Export.xlsx&#34;</span>
</span></span><span style=display:flex><span>    WorkSheetname = <span style=color:#e6db74>&#34;DatabaseLevel&#34;</span>
</span></span><span style=display:flex><span>    TableName = <span style=color:#e6db74>&#34;DatabaseLevel&#34;</span>
</span></span><span style=display:flex><span>    FreezeTopRow = $true
</span></span><span style=display:flex><span>    TableStyle = <span style=color:#e6db74>&#34;Medium6&#34;</span>
</span></span><span style=display:flex><span>    AutoSize      = $true
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e># I have added the `-Show` switch parameter which will open the file after its&#39; generation</span>
</span></span><span style=display:flex><span>$dbRoleMembers | Export-Excel @excelDBRoleMembersOutput -Show
</span></span></code></pre></div><h2 id=parameterize-the-script>Parameterize the script</h2><p>As I know that I will be using this heavily, I decided to create some variables to be set at the top of the script and use them in the commands. This way, I have just to change the instance name and run the command. You can also pick this code and wrap around a function and include the <code>param()</code> block so you can call it from the command line.</p><p>You can find all the parameters I use between lines 1 and 10.</p><h3 id=putting-all-together---the-full-script>Putting all together - The full script</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$SQLInstance = <span style=color:#e6db74>&#34;instance1&#34;</span>
</span></span><span style=display:flex><span>$excludeDatabase = <span style=color:#e6db74>&#34;myDB&#34;</span>, <span style=color:#e6db74>&#34;myDB2&#34;</span>
</span></span><span style=display:flex><span>$excludeLogin = <span style=color:#e6db74>&#34;renamedSA&#34;</span>
</span></span><span style=display:flex><span>$excludeLoginFilter = <span style=color:#e6db74>&#34;NT *&#34;</span>, <span style=color:#e6db74>&#34;##*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># To be used on Export-Excel command</span>
</span></span><span style=display:flex><span>$excelFilepath = <span style=color:#e6db74>&#34;D:\$SQLInstance_</span>$((Get-Date).ToFileTime())<span style=color:#e6db74>.xlsx&#34;</span>
</span></span><span style=display:flex><span>$freezeTopRow = $true
</span></span><span style=display:flex><span>$tableStyle = <span style=color:#e6db74>&#34;Medium6&#34;</span>
</span></span><span style=display:flex><span>$autoSize = $true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Region Get data</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get all instance logins</span>
</span></span><span style=display:flex><span>$Logins = Get-DbaLogin -SqlInstance $SQLInstance -ExcludeLogin $excludeLogin -ExcludeFilter $excludeLoginFilter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get all server roles and its members</span>
</span></span><span style=display:flex><span>$instanceRoleMembers = Get-DbaServerRoleMember -SqlInstance $SQLInstance -Login $Logins.Name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get all database roles and its members</span>
</span></span><span style=display:flex><span>$dbRoleMembers = Get-DbaDbRoleMember -SqlInstance $SQLInstance -ExcludeDatabase $excludeDatabase | Where-Object UserName -in $logins.Name
</span></span><span style=display:flex><span><span style=color:#75715e>#EndRegion</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Remove the report file if exists</span>
</span></span><span style=display:flex><span>Remove-Item -Path $excelFilepath -Force -ErrorAction SilentlyContinue
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Region Export Data to Excel</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Export data to Excel</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Export Logins</span>
</span></span><span style=display:flex><span>$excelLoginSplatting = @{
</span></span><span style=display:flex><span>    Path = $excelFilepath
</span></span><span style=display:flex><span>    WorkSheetname = <span style=color:#e6db74>&#34;Logins&#34;</span>
</span></span><span style=display:flex><span>    TableName = <span style=color:#e6db74>&#34;Logins&#34;</span>
</span></span><span style=display:flex><span>    FreezeTopRow = $freezeTopRow
</span></span><span style=display:flex><span>    TableStyle = $tableStyle
</span></span><span style=display:flex><span>    AutoSize = $true
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>$Logins | Select-Object <span style=color:#e6db74>&#34;ComputerName&#34;</span>, <span style=color:#e6db74>&#34;InstanceName&#34;</span>, <span style=color:#e6db74>&#34;SqlInstance&#34;</span>, <span style=color:#e6db74>&#34;Name&#34;</span>, <span style=color:#e6db74>&#34;LoginType&#34;</span>, <span style=color:#e6db74>&#34;CreateDate&#34;</span>, <span style=color:#e6db74>&#34;LastLogin&#34;</span>, <span style=color:#e6db74>&#34;HasAccess&#34;</span>, <span style=color:#e6db74>&#34;IsLocked&#34;</span>, <span style=color:#e6db74>&#34;IsDisabled&#34;</span> | Export-Excel @excelLoginSplatting
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Export instance roles and its members</span>
</span></span><span style=display:flex><span>$excelinstanceRoleMembersOutput = @{
</span></span><span style=display:flex><span>    Path = $excelFilepath
</span></span><span style=display:flex><span>    WorkSheetname = <span style=color:#e6db74>&#34;InstanceLevel&#34;</span>
</span></span><span style=display:flex><span>    TableName = <span style=color:#e6db74>&#34;InstanceLevel&#34;</span>
</span></span><span style=display:flex><span>    TableStyle = $tableStyle
</span></span><span style=display:flex><span>    FreezeTopRow = $freezeTopRow
</span></span><span style=display:flex><span>    AutoSize = $autoSize
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>$instanceRoleMembers | Export-Excel @excelinstanceRoleMembersOutput
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Export database roles and its members</span>
</span></span><span style=display:flex><span>$exceldbRoleMembersOutput = @{
</span></span><span style=display:flex><span>    Path = $excelFilepath
</span></span><span style=display:flex><span>    WorkSheetname = <span style=color:#e6db74>&#34;DatabaseLevel&#34;</span>
</span></span><span style=display:flex><span>    TableName = <span style=color:#e6db74>&#34;DatabaseLevel&#34;</span>
</span></span><span style=display:flex><span>    TableStyle = $tableStyle
</span></span><span style=display:flex><span>    FreezeTopRow = $freezeTopRow
</span></span><span style=display:flex><span>    AutoSize = $autoSize
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>$dbRoleMembers | Export-Excel @exceldbRoleMembersOutput
</span></span><span style=display:flex><span><span style=color:#75715e>#EndRegion</span>
</span></span></code></pre></div><h2 id=faq>FAQ</h2><h3 id=what-if-i-want-to-get-different-properties>What if I want to get different properties?</h3><p>In the script, you can change the output list by changing the properties used on the <code>Select-Object</code> cmdlet (line 37).</p><h3 id=how-can-i-make-the-excel-file-open-automatically-after-exporting-all-data>How can I make the Excel file open automatically after exporting all data?</h3><p>As shown on the &ldquo;ImportExcel command&rdquo; section, you can add the <code>-Show</code> parameter on the last <code>Export-Excel</code> command (line 62).</p><h2 id=whats-next>What&rsquo;s next?</h2><p>Want a slight change? Use the same technique but with different commands?
Hopefully, this article gave you some ideas. Now it&rsquo;s a question of changing the commands that get data for the ones you want and apply the same recipe to output to an Excel file.</p><h2 id=wrap-up>Wrap up</h2><p>In this article we could see how easy and fast an Excel file with multiple spreadsheets can be generate, each with a table with filters, colors, etc and..we don&rsquo;t even need to have Microsoft Excel installed on the machine where we are running commands!</p><p>Thanks for reading!</p></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-footer-tags><span class="text-color-light text-small">TAGGED IN</span><br><a class="tag tag--primary tag--small" href=/tags/Automation/>Automation</a>
<a class="tag tag--primary tag--small" href=/tags/dbatools/>dbatools</a>
<a class="tag tag--primary tag--small" href=/tags/Export/>Export</a>
<a class="tag tag--primary tag--small" href=/tags/Permissions/>Permissions</a>
<a class="tag tag--primary tag--small" href=/tags/PowerShell/>PowerShell</a>
<a class="tag tag--primary tag--small" href=/tags/roles/>roles</a>
<a class="tag tag--primary tag--small" href=/tags/Scripting/>Scripting</a>
<a class="tag tag--primary tag--small" href=/tags/Security/>Security</a>
<a class="tag tag--primary tag--small" href=/tags/SQLServer/>SQLServer</a>
<a class="tag tag--primary tag--small" href=/tags/syndicated/>syndicated</a></div><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2020/09/03/When-one-of-your-DBA-colleagues-leaves-the-company-what-is-your-checklist/ data-tooltip="When one of your DBA colleagues leaves the company, what is your checklist?" aria-label="NEXT: When one of your DBA colleagues leaves the company, what is your checklist?"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2020/06/09/TSQL-Tuesday-127-Non-SQL-Tips-and-Tricks-Windows/ data-tooltip="TSQL Tuesday 127 - Non SQL Tips and Tricks - Windows" aria-label="PREVIOUS: TSQL Tuesday 127 - Non SQL Tips and Tricks - Windows"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2020/07/31/Generate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2020/07/31/Generate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2020/07/31/Generate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div><div class=comments><script src=https://utteranc.es/client.js repo=ClaudioESSilva/blog-comments issue-term=og:title theme=github-light crossorigin=anonymous async></script></div></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2022 Cláudio Silva. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=4><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2020/09/03/When-one-of-your-DBA-colleagues-leaves-the-company-what-is-your-checklist/ data-tooltip="When one of your DBA colleagues leaves the company, what is your checklist?" aria-label="NEXT: When one of your DBA colleagues leaves the company, what is your checklist?"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2020/06/09/TSQL-Tuesday-127-Non-SQL-Tips-and-Tricks-Windows/ data-tooltip="TSQL Tuesday 127 - Non SQL Tips and Tricks - Windows" aria-label="PREVIOUS: TSQL Tuesday 127 - Non SQL Tips and Tricks - Windows"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2020/07/31/Generate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2020/07/31/Generate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2020/07/31/Generate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div></div><div id=share-options-bar class=share-options-bar data-behavior=4><i id=btn-close-shareoptions class="fa fa-times"></i><ul class=share-options><li class=share-option><a class=share-option-btn target=new href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fclaudioessilva.eu%2F2020%2F07%2F31%2FGenerate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules%2F" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i><span>Share on Facebook</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fclaudioessilva.eu%2F2020%2F07%2F31%2FGenerate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules%2F" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i><span>Share on Twitter</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fclaudioessilva.eu%2F2020%2F07%2F31%2FGenerate-SQL-Server-Role-Member-Reports-using-dbatools-and-ImportExcel-PowerShell-modules%2F" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i><span>Share on Linkedin</span></a></li></ul></div><div id=share-options-mask class=share-options-mask></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-times"></i></div><img id=about-card-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"><h4 id=about-card-name>Cláudio Silva</h4><div id=about-card-bio>Data Platform Architect and PowerShell lover.</div><div id=about-card-job><i class="fa fa-briefcase"></i><br>Data Platform Architect</div><div id=about-card-location><i class="fa fa-map-marker-alt"></i><br>Portugal</div></div></div><div id=cover style=background-image:url(https://claudioessilva.eu/images/cover_bridge.jpg)></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://claudioessilva.eu/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js></script>
<script>$(document).ready(function(){hljs.configure({classPrefix:"",useBR:!1}),$("pre.code-highlight > code, pre > code").each(function(e,t){$(this).hasClass("codeblock")||$(this).addClass("codeblock"),hljs.highlightBlock(t)})})</script></body></html>