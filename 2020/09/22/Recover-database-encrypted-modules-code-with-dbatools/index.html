<!doctype html><html lang=en-us><head><script type=application/ld+json>{"@context":"http://schema.org","@type":"Website","@id":"https:\/\/claudioessilva.eu\/","author":{"@type":"Person","name":"Cláudio Silva","image":"https://claudioessilva.eu/img/avatar.jpg"},"name":"Cláudio Silva\u0027s Blog","description":"This article was initially posted on SQLServerCentral @ 2020-08-18. It was interesting some comments I read about it, mainly why people still use WITH ENCRYPTION when it\u0026rsquo;s simple to overcome this when we have the right permissions.\nSQL Server offers an option to encrypt the code of your modules when using the WITH ENCRYPTION syntax. This allows to hide\/obfuscate the modules\u0026rsquo; code and thus keep away from prying eyes. It\u0026rsquo;s often used to protect business rules since it allows you to protect some intellectual property.","url":"https:\/\/claudioessilva.eu\/2020\/09\/22\/Recover-database-encrypted-modules-code-with-dbatools\/","keywords":"[]"}</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo 0.128.2 with theme Tranquilpeak 0.5.3-BETA"><meta name=author content="Cláudio Silva"><meta name=keywords content><meta name=description content="This article was initially posted on SQLServerCentral @ 2020-08-18. It was interesting some comments I read about it, mainly why people still use WITH ENCRYPTION when it&rsquo;s simple to overcome this when we have the right permissions.
SQL Server offers an option to encrypt the code of your modules when using the WITH ENCRYPTION syntax. This allows to hide/obfuscate the modules&rsquo; code and thus keep away from prying eyes. It&rsquo;s often used to protect business rules since it allows you to protect some intellectual property."><meta property="og:description" content="This article was initially posted on SQLServerCentral @ 2020-08-18. It was interesting some comments I read about it, mainly why people still use WITH ENCRYPTION when it&rsquo;s simple to overcome this when we have the right permissions.
SQL Server offers an option to encrypt the code of your modules when using the WITH ENCRYPTION syntax. This allows to hide/obfuscate the modules&rsquo; code and thus keep away from prying eyes. It&rsquo;s often used to protect business rules since it allows you to protect some intellectual property."><meta property="og:type" content="article"><meta property="og:title" content="Recover database encrypted modules code with dbatools"><meta name=twitter:title content="Recover database encrypted modules code with dbatools"><meta property="og:url" content="https://claudioessilva.eu/2020/09/22/Recover-database-encrypted-modules-code-with-dbatools/"><meta property="twitter:url" content="https://claudioessilva.eu/2020/09/22/Recover-database-encrypted-modules-code-with-dbatools/"><meta property="og:site_name" content="Cláudio Silva's Blog"><meta property="og:description" content="This article was initially posted on SQLServerCentral @ 2020-08-18. It was interesting some comments I read about it, mainly why people still use WITH ENCRYPTION when it&rsquo;s simple to overcome this when we have the right permissions.
SQL Server offers an option to encrypt the code of your modules when using the WITH ENCRYPTION syntax. This allows to hide/obfuscate the modules&rsquo; code and thus keep away from prying eyes. It&rsquo;s often used to protect business rules since it allows you to protect some intellectual property."><meta name=twitter:description content="This article was initially posted on SQLServerCentral @ 2020-08-18. It was interesting some comments I read about it, mainly why people still use WITH ENCRYPTION when it&rsquo;s simple to overcome this when we have the right permissions.
SQL Server offers an option to encrypt the code of your modules when using the WITH ENCRYPTION syntax. This allows to hide/obfuscate the modules&rsquo; code and thus keep away from prying eyes. It&rsquo;s often used to protect business rules since it allows you to protect some intellectual property."><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2020-09-22T00:00:00"><meta property="article:modified_time" content="2020-09-22T00:00:00"><meta property="article:tag" content="Automation"><meta property="article:tag" content="dbatools"><meta property="article:tag" content="Decrypt"><meta property="article:tag" content="PowerShell"><meta property="article:tag" content="Scripting"><meta property="article:tag" content="Security"><meta property="article:tag" content="SQLServer"><meta property="article:tag" content="syndicated"><meta property="article:tag" content="WITH ENCRYPTION"><meta name=twitter:card content="summary"><meta name=twitter:site content="@claudioessilva"><meta name=twitter:creator content="@claudioessilva"><meta property="og:image" content="https://claudioessilva.eu/img/avatar.jpg"><meta property="twitter:image" content="https://claudioessilva.eu/img/avatar.jpg"><title>Recover database encrypted modules code with dbatools</title>
<link rel=icon href=https://claudioessilva.eu/img/favicon.jpg><link rel=canonical href=https://claudioessilva.eu/2020/09/22/Recover-database-encrypted-modules-code-with-dbatools/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://claudioessilva.eu/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css></head><body><div id=blog><header id=header data-behavior=4><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=/ aria-label="Go to homepage">Cláudio Silva's Blog</a></div><a class=header-right-picture href=/#about aria-label="Open the link: /#about"><img class=header-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a></header><nav id=sidebar data-behavior=4><div class=sidebar-container><div class=sidebar-profile><a href=/#about aria-label="Read more about the author"><img class=sidebar-profile-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a><h4 class=sidebar-profile-name>Cláudio Silva</h4><h5 class=sidebar-profile-bio>Data Platform Architect and PowerShell lover.</h5></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/ title=Home><i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden=true></i>
<span class=sidebar-button-desc>Home</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/tags title=Tags><i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden=true></i>
<span class=sidebar-button-desc>Tags</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/#about title=About><i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden=true></i>
<span class=sidebar-button-desc>About</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://github.com/claudioessilva target=_blank rel=noopener title=GitHub><i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden=true></i>
<span class=sidebar-button-desc>GitHub</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://twitter.com/claudioessilva target=_blank rel=noopener title=Twitter><i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden=true></i>
<span class=sidebar-button-desc>Twitter</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://www.linkedin.com/in/claudioessilva target=_blank rel=noopener title=LinkedIn><i class="sidebar-button-icon fab fa-lg fa-linkedin" aria-hidden=true></i>
<span class=sidebar-button-desc>LinkedIn</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/index.xml title=RSS><i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden=true></i>
<span class=sidebar-button-desc>RSS</span></a></li></ul></div><div class=sidebar-container><div style=color:#ebebeb;font-size:25px;text-align:center>dbatools book</div><div style=color:#ebebeb;font-size:15px>Now available! Buy it at manning.com - 50% off with code bldbatools50</div><a href="https://www.manning.com/books/learn-dbatools-in-a-month-of-lunches?utm_source=claudioessilva&utm_medium=affiliate&utm_campaign=affiliate&a_aid=claudioessilva" target=_blank><center><img src=https://images.manning.com/264/352/resize/book/0/998b76f-982a-4661-a020-5d94909f7ea5/LeMaire-HI.png height=300></center></a></div></nav><div id=main data-behavior=4 class=hasCoverMetaIn><article class=post id=top><div class="post-header main-content-wrap text-left"><h1 class=post-title>Recover database encrypted modules code with dbatools</h1><div class="postShorten-meta post-meta"><time datetime=2020-09-22T00:00:00Z>September 22, 2020</time></div></div><div class="post-content markdown"><div class=main-content-wrap><p>This article was initially posted on <a href=https://www.sqlservercentral.com/articles/recover-database-encrypted-modules-code-with-dbatools target=_blank rel="noopener noreferrer">SQLServerCentral
</a>@ 2020-08-18.
It was interesting some comments I read about it, mainly why people still use <code>WITH ENCRYPTION</code> when it&rsquo;s simple to overcome this when we have the right permissions.</p><p>SQL Server offers an option to encrypt the code of your modules when using the <code>WITH ENCRYPTION</code> syntax.
This allows to hide/obfuscate the modules&rsquo; code and thus keep away from prying eyes.
It&rsquo;s often used to protect business rules since it allows you to protect some intellectual property.</p><p>In this article, we will look at how to recover the code from encrypted modules.</p><h2 id=what-is-a-module-in-sql-server>What is a module in SQL Server?</h2><p>In the SQL Server world, a module consists of a block(s) of T-SQL statements that make up a stored procedure, a function, a trigger or a view definition.</p><h3 id=which-modules-can-be-encrypted>Which modules can be encrypted?</h3><p>These are the objects&rsquo; types that can be encrypted:</p><ul><li>P - Stored procedures</li><li>V - Views</li><li>TR - Triggers</li><li>FN, IF, TF - Functions</li></ul><p>On the other hand, the following types also appear in <code>sys.sql_modules</code>, but they can&rsquo;t be encrypted:</p><ul><li>RF - Replication-filter-procedure</li><li>R - Rule</li><li>D - Default</li></ul><p>You can run the following T-SQL statement to check on <a href=https://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-sql-modules-transact-sql target=_blank rel="noopener noreferrer">sys.sql_modules
</a>which objects you have and if they are encrypted or not (the <code>definition</code> column has the <code>NULL</code> value).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> sm.object_id, o.name, o.<span style=color:#66d9ef>type</span>, sm.definition
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> sys.sql_modules sm
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> sys.objects O
</span></span><span style=display:flex><span>	   <span style=color:#66d9ef>ON</span> sm.object_id <span style=color:#f92672>=</span> o.object_id
</span></span></code></pre></div><p><img src=/img/2020/09/sys-sql_modules.png alt=syssqlmodules></p><h3 id=what-happens-to-the-module-text-when-we-specify-with-encryption>What happens to the module text when we specify WITH ENCRYPTION?</h3><p>From the <a href=https://docs.microsoft.com/en-us/sql/t-sql/statements/create-procedure-transact-sql target=_blank rel="noopener noreferrer">CREATE PROCEDURE
</a>documentation, <code>WITH ENCRYPTION</code>:</p><blockquote><p>&mldr;SQL Server converts the original text of the CREATE [enter object type here] statement to an obfuscated format. The output of the obfuscation is not directly visible in any of the catalog views in SQL Server. Users who have no access to system tables or database files cannot retrieve the obfuscated text. However, the text is available to privileged users who can either access system tables over the DAC port or directly access database files. Also, users who can attach a debugger to the server process can retrieve the decrypted procedure from memory at runtime. For more information about accessing system metadata, see Metadata Visibility Configuration.</p></blockquote><p>If you want to understand the <a href=https://sqlperformance.com/2016/05/sql-performance/the-internals-of-with-encryption target=_blank rel="noopener noreferrer">Internals of With Encryption
</a>make sure you read Paul White’s (<a href=https://www.sql.kiwi/ target=_blank rel="noopener noreferrer">
b
</a>| <a href=https://twitter.com/sql_kiwi target=_blank rel="noopener noreferrer">t
</a>) blog post.</p><h2 id=a-story>A Story</h2><p>I would like to share a story about encrypted modules.</p><p>I inherited a database with encrypted modules but without native scripts. This isn&rsquo;t something that happens too often, however, it can happen and it&rsquo;s not a nice feeling. All of a sudden we inherit a database or a client requests help because they don&rsquo;t have the source code of the modules.</p><p>My tool of choice for recovering the code was dbatools.</p><h3 id=choosing-a-tool>Choosing a Tool</h3><p>There are multiple ways to retrieve the decrypted version of an encrypted module. We can use a T-SQL script or other third-party tools. Here are a few that you can use:</p><ul><li><a href=https://gist.github.com/jstangroome/4020443 target=_blank rel="noopener noreferrer">T-SQL</a></li><li><a href=https://www.systoolsgroup.com/sql-decryptor.html target=_blank rel="noopener noreferrer">SQLDecryptor</a></li><li><a href=https://www.devart.com/dbforge/sql/sqldecryptor/ target=_blank rel="noopener noreferrer">dbForge SQL Decryptor</a></li><li><a href=https://docs.dbatools.io/#Invoke-DbaDbDecryptObject target=_blank rel="noopener noreferrer">Invoke-DbaDbDecryptObject command from dbatools PowerShell module</a></li></ul><p>The last one will be our focus in this article. Here I will be focusing on how we can do it at scale and with a couple of different use cases.</p><p>If you want to understand how dbatools does it, Sander Stad (<a href=https://www.sqlstad.nl/ target=_blank rel="noopener noreferrer">
b
</a>| <a href=https://www.sqlstad.nl/ target=_blank rel="noopener noreferrer">t
</a>) was the person that wrote this dbatools&rsquo; function and he explains it on his blog post <a href=https://www.sqlstad.nl/powershell/decrypting-sql-server-objects-with-dbatools/ target=_blank rel="noopener noreferrer">Decrypting SQL Server Objects With dbatools
</a>.</p><p>Here I will be focusing on how we can do it at scale and with a couple of different use cases.</p><h2 id=prerequisites>Prerequisites</h2><p>There are a few items you need to follow along with this article.</p><h3 id=dbatools>dbatools</h3><p>You can install the latest version of the module from the PowerShell Gallery by running the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Install-Module -Name dbatools
</span></span></code></pre></div><h3 id=dac>DAC</h3><p>Stands for <a href=https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/diagnostic-connection-for-database-administrators target=_blank rel="noopener noreferrer">Dedicated Admin Connection
</a>.</p><blockquote><p>The DAC lets an administrator access a running server to execute diagnostic functions or Transact-SQL statements, or to troubleshoot problems on the server, even when the server is locked or running in an abnormal state and not responding to a SQL Server Database Engine connection.</p></blockquote><p>If you want to connect using DAC from a remote server, you need to configure the <a href=https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/remote-admin-connections-server-configuration-option target=_blank rel="noopener noreferrer">remote admin connection
</a>option as the default is 0 (off).</p><h4 id=using-dbatools-to-checkset-the-remote-admin-connection-configuration>Using dbatools to check/set the &lsquo;remote admin connection&rsquo; configuration</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-DbaSpConfigure -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -ConfigName RemoteDacConnectionsEnabled
</span></span></code></pre></div><p>If you want to be able to run this from a remote server, the output should say 1 in the <code>ConfiguredValue</code> property.</p><p>If the output says 0 (zero), you can use dbatools to change it to 1, by doing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Set-DbaSpConfigure -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -ConfigName RemoteDacConnectionsEnabled -Value <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>NOTE: In some cases, you may need to restart the instance.</p><h2 id=examples>Examples</h2><p>If you&rsquo;re curious about the steps that are simplified by dbatools, you can visit Paul White&rsquo;s <a href=https://sqlperformance.com/2016/05/sql-performance/the-internals-of-with-encryption target=_blank rel="noopener noreferrer">post
</a>(referenced before) to see how it&rsquo;s done in T-SQL.</p><p>I want to say that this is OK if we are talking about a couple of modules. However, that&rsquo;s not the case of our scenario, where we want to decrypt all objects of a specific database and this may be translated into dozens of objects.</p><p>Let&rsquo;s see how to use dbatools to eliminate hard and repetitive work.</p><h3 id=a-couple-of-tests>A couple of tests</h3><p>Before I go through all objects, I decided to start by doing a test by decrypting a single object to check the outcome</p><h4 id=decrypt-a-single-object-on-a-single-database>Decrypt a single object on a single database</h4><p>The following code will decrypt just a single object and output the result to the console</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Invoke-DbaDbDecryptObject -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -Database <span style=color:#e6db74>&#34;WithEncryption&#34;</span> -ObjectName <span style=color:#e6db74>&#34;MySecretSauce&#34;</span>
</span></span></code></pre></div><p><img src=/img/2020/09/decryptsingleobject.png alt=decryptsingleobject></p><h4 id=we-can-also-decrypt-more-than-one-object-in-the-same-execution>We can also decrypt more than one object in the same execution</h4><p>Now that I understand what my outcome is, let&rsquo;s try to decrypt two objects from the same database</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Invoke-DbaDbDecryptObject -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -Database <span style=color:#e6db74>&#34;WithEncryption&#34;</span> -ObjectName <span style=color:#e6db74>&#34;MySecretSauce&#34;</span>, <span style=color:#e6db74>&#34;MySecret&#34;</span>
</span></span></code></pre></div><p><img src=/img/2020/09/decrypttwoobjects.png alt=decrypttwoobjects></p><p>NOTE: If you want to decrypt all encrypted objects that belong to a specific database you just need to omit the <code>-ObjectName</code> parameter.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Invoke-DbaDbDecryptObject -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -Database <span style=color:#e6db74>&#34;WithEncryption&#34;</span>
</span></span></code></pre></div><h2 id=what-if-i-want-to-save-the-results-to-file>What if I want to save the results to file?!</h2><p>Back to my story, I knew that I would like to save a decrypted version of each object. This way we can edit the code and update the module or just to keep a readable copy of it (don&rsquo;t forget to keep it on your versioning tool).</p><p>Ultimately, I have decided to do the following:</p><ol><li>Save a decrypted version of each object as a T-SQL script.</li><li>Compile SQL scripts but without encryption on a different/same database</li></ol><h3 id=saving-results-to-a-local-folder>Saving results to a local folder</h3><p>To do so, with dbatools, we just need to define the <code>-ExportDestination</code> parameter and indicate to which folder we want to output our decrypted T-SQL code. This command will create a folder for each type of objects, and within and you will find one SQL script per object that was decrypted.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Invoke-DbaDbDecryptObject -SqlInstance <span style=color:#e6db74>&#34;instance1&#34;</span> -Database <span style=color:#e6db74>&#34;WithEncryption&#34;</span> -ExportDestination <span style=color:#e6db74>&#34;d:\temp\&#34;</span>
</span></span></code></pre></div><p><img src=/img/2020/09/outout.png alt=outout></p><h3 id=compile-sql-scripts-but-without-encryption-on-a-differentsame-database>Compile SQL scripts but without encryption on a different/same database</h3><p>If you open any of these decrypted files, you will see that the <code>WITH ENCRYPTION</code> keywords are there, which means that it will encrypt the code if you run it.</p><p><img src=/img/2020/09/afterdecrypt.png alt=decrypttwoobjects></p><p>If you want to replace all encrypted (Stored Procedures, for example) version by the decrypted version, you will need to:</p><ol><li>drop encrypted Stored Procedures objects</li><li>Comment/remove the <code>WITH ENCRYPTION</code></li><li>Compile them on the database</li></ol><p>To check which stored procedures are encrypted, you can use the <code>Get-DbaDbStoredProcedure</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$instance = <span style=color:#e6db74>&#34;instance1&#34;</span>
</span></span><span style=display:flex><span>$database = <span style=color:#e6db74>&#34;myDB&#34;</span>
</span></span><span style=display:flex><span>$SPs = Get-DbaDbStoredProcedure -SqlInstance $instance -Database $database -ExcludeSystemSp | Where-Object IsEncrypted <span style=color:#f92672>-eq</span> $true
</span></span><span style=display:flex><span>$SPs | Select-Object InstanceName, Database, Schema, Name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># The next line is a comment on purpose to avoid accidents :-). However, it is an option that you can use to DROP the stored procedures</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># The next line is a comment on purpose to avoid accidents :-). However, it is an option that you can use to DROP the stored procedures</span>
</span></span><span style=display:flex><span><span style=color:#75715e># $SPs | Foreach-object {$_.Drop()}</span>
</span></span></code></pre></div><p>Here is a script to run the steps two and three:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$instance = <span style=color:#e6db74>&#34;instance1&#34;</span>
</span></span><span style=display:flex><span>$database = <span style=color:#e6db74>&#34;myDB&#34;</span>
</span></span><span style=display:flex><span>$modulesFolder = <span style=color:#e6db74>&#34;D:\temp\</span>$instance<span style=color:#e6db74>\</span>$database<span style=color:#e6db74>\StoredProcedure&#34;</span>
</span></span><span style=display:flex><span>$objectsList = (Get-ChildItem -Path $modulesFolder -Recurse -Filter <span style=color:#e6db74>&#34;*.sql*&#34;</span>) | Select-Object -ExpandProperty FullName
</span></span><span style=display:flex><span><span style=color:#66d9ef>foreach</span> ($object <span style=color:#66d9ef>in</span> $objectsList) {
</span></span><span style=display:flex><span>    $TSQLcode = (Get-Content -Path $object -Raw) <span style=color:#f92672>-replace</span> <span style=color:#e6db74>&#39;\bWITH ENCRYPTION\b&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    Invoke-DbaQuery -SqlInstance $instance -Database $database -Query $TSQLcode
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here we can see that the Stored Procedure is no longer encrypted</p><p><img src=/img/2020/09/outout_noencrypted.png alt=outoutnoencrypted></p><h2 id=wrapping-up>Wrapping up</h2><p>We have seen how we can leverage dbatools PowerShell module to do the hard work for us when it comes to decrypting modules.
This can be useful to recover lost code, make backups even for versioning it.
Hopefully, it is nothing that you will need to use every single day! But, if that day arrives you will be prepared with another tool to make your life easier!</p><p>Thanks for reading!</p></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-footer-tags><span class="text-color-light text-small">TAGGED IN</span><br><a class="tag tag--primary tag--small" href=/tags/Automation/>Automation</a>
<a class="tag tag--primary tag--small" href=/tags/dbatools/>dbatools</a>
<a class="tag tag--primary tag--small" href=/tags/Decrypt/>Decrypt</a>
<a class="tag tag--primary tag--small" href=/tags/PowerShell/>PowerShell</a>
<a class="tag tag--primary tag--small" href=/tags/Scripting/>Scripting</a>
<a class="tag tag--primary tag--small" href=/tags/Security/>Security</a>
<a class="tag tag--primary tag--small" href=/tags/SQLServer/>SQLServer</a>
<a class="tag tag--primary tag--small" href=/tags/syndicated/>syndicated</a>
<a class="tag tag--primary tag--small" href=/tags/WITH-ENCRYPTION/>WITH ENCRYPTION</a></div><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2021/12/29/A-big-SQLPackage-caveat/ data-tooltip="A (big) SQLPackage caveat" aria-label="NEXT: A (big) SQLPackage caveat"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2020/09/03/When-one-of-your-DBA-colleagues-leaves-the-company-what-is-your-checklist/ data-tooltip="When one of your DBA colleagues leaves the company, what is your checklist?" aria-label="PREVIOUS: When one of your DBA colleagues leaves the company, what is your checklist?"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2020/09/22/Recover-database-encrypted-modules-code-with-dbatools/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2020/09/22/Recover-database-encrypted-modules-code-with-dbatools/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2020/09/22/Recover-database-encrypted-modules-code-with-dbatools/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div><div class=comments><script src=https://utteranc.es/client.js repo=ClaudioESSilva/blog-comments issue-term=og:title theme=github-light crossorigin=anonymous async></script></div></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2024 Cláudio Silva. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=4><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2021/12/29/A-big-SQLPackage-caveat/ data-tooltip="A (big) SQLPackage caveat" aria-label="NEXT: A (big) SQLPackage caveat"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2020/09/03/When-one-of-your-DBA-colleagues-leaves-the-company-what-is-your-checklist/ data-tooltip="When one of your DBA colleagues leaves the company, what is your checklist?" aria-label="PREVIOUS: When one of your DBA colleagues leaves the company, what is your checklist?"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2020/09/22/Recover-database-encrypted-modules-code-with-dbatools/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2020/09/22/Recover-database-encrypted-modules-code-with-dbatools/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2020/09/22/Recover-database-encrypted-modules-code-with-dbatools/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div></div><div id=share-options-bar class=share-options-bar data-behavior=4><i id=btn-close-shareoptions class="fa fa-times"></i><ul class=share-options><li class=share-option><a class=share-option-btn target=new href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fclaudioessilva.eu%2F2020%2F09%2F22%2FRecover-database-encrypted-modules-code-with-dbatools%2F" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i><span>Share on Facebook</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fclaudioessilva.eu%2F2020%2F09%2F22%2FRecover-database-encrypted-modules-code-with-dbatools%2F" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i><span>Share on Twitter</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fclaudioessilva.eu%2F2020%2F09%2F22%2FRecover-database-encrypted-modules-code-with-dbatools%2F" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i><span>Share on Linkedin</span></a></li></ul></div><div id=share-options-mask class=share-options-mask></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-times"></i></div><img id=about-card-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"><h4 id=about-card-name>Cláudio Silva</h4><div id=about-card-bio>Data Platform Architect and PowerShell lover.</div><div id=about-card-job><i class="fa fa-briefcase"></i><br>Data Platform Architect</div><div id=about-card-location><i class="fa fa-map-marker-alt"></i><br>Portugal</div></div></div><div id=cover style=background-image:url(https://claudioessilva.eu/images/cover_bridge.jpg)></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://claudioessilva.eu/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js></script><script>$(document).ready(function(){hljs.configure({classPrefix:"",useBR:!1}),$("pre.code-highlight > code, pre > code").each(function(e,t){$(this).hasClass("codeblock")||$(this).addClass("codeblock"),hljs.highlightBlock(t)})})</script></body></html>