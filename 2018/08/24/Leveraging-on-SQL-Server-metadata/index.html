<!doctype html><html lang=en-us><head><script type=application/ld+json>{"@context":"http://schema.org","@type":"Website","@id":"https:\/\/claudioessilva.eu","author":{"@type":"Person","name":"Cláudio Silva","image":"https://claudioessilva.eu/img/avatar.jpg"},"name":"Cláudio Silva\u0027s Blog","description":"I\u0026rsquo;m working on a project where I need to convert Firebird SQL code into T-SQL code. No schema, just the modules. There are more than 1000 objects between stored procedures, views, triggers, user-defined data types, etc.\nFirst - the pain\u0026hellip; While checking the Firebird reference manuals I saw a lot of different concepts (Selectable Stored Procedures - Yes you can do SELECT FROM StoredProcedure) and different functions names with different syntax compared to T-SQL.","url":"https:\/\/claudioessilva.eu\/2018\/08\/24\/Leveraging-on-SQL-Server-metadata\/","keywords":"[]"}</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo 0.122.0 with theme Tranquilpeak 0.5.3-BETA"><meta name=author content="Cláudio Silva"><meta name=keywords content><meta name=description content="I&rsquo;m working on a project where I need to convert Firebird SQL code into T-SQL code. No schema, just the modules. There are more than 1000 objects between stored procedures, views, triggers, user-defined data types, etc.
First - the pain&mldr; While checking the Firebird reference manuals I saw a lot of different concepts (Selectable Stored Procedures - Yes you can do SELECT FROM StoredProcedure) and different functions names with different syntax compared to T-SQL."><meta property="og:description" content="I&rsquo;m working on a project where I need to convert Firebird SQL code into T-SQL code. No schema, just the modules. There are more than 1000 objects between stored procedures, views, triggers, user-defined data types, etc.
First - the pain&mldr; While checking the Firebird reference manuals I saw a lot of different concepts (Selectable Stored Procedures - Yes you can do SELECT FROM StoredProcedure) and different functions names with different syntax compared to T-SQL."><meta property="og:type" content="article"><meta property="og:title" content="Leveraging on SQL Server metadata"><meta name=twitter:title content="Leveraging on SQL Server metadata"><meta property="og:url" content="https://claudioessilva.eu/2018/08/24/Leveraging-on-SQL-Server-metadata/"><meta property="twitter:url" content="https://claudioessilva.eu/2018/08/24/Leveraging-on-SQL-Server-metadata/"><meta property="og:site_name" content="Cláudio Silva's Blog"><meta property="og:description" content="I&rsquo;m working on a project where I need to convert Firebird SQL code into T-SQL code. No schema, just the modules. There are more than 1000 objects between stored procedures, views, triggers, user-defined data types, etc.
First - the pain&mldr; While checking the Firebird reference manuals I saw a lot of different concepts (Selectable Stored Procedures - Yes you can do SELECT FROM StoredProcedure) and different functions names with different syntax compared to T-SQL."><meta name=twitter:description content="I&rsquo;m working on a project where I need to convert Firebird SQL code into T-SQL code. No schema, just the modules. There are more than 1000 objects between stored procedures, views, triggers, user-defined data types, etc.
First - the pain&mldr; While checking the Firebird reference manuals I saw a lot of different concepts (Selectable Stored Procedures - Yes you can do SELECT FROM StoredProcedure) and different functions names with different syntax compared to T-SQL."><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2018-08-24T00:00:00"><meta property="article:modified_time" content="2018-08-24T00:00:00"><meta property="article:tag" content="Automation"><meta property="article:tag" content="Firebird"><meta property="article:tag" content="Metadata"><meta property="article:tag" content="PowerShell"><meta property="article:tag" content="SQL Server"><meta property="article:tag" content="SQLPrompt"><meta property="article:tag" content="SQLServer"><meta property="article:tag" content="syndicated"><meta name=twitter:card content="summary"><meta name=twitter:site content="@claudioessilva"><meta name=twitter:creator content="@claudioessilva"><meta property="og:image" content="https://claudioessilva.eu/img/avatar.jpg"><meta property="twitter:image" content="https://claudioessilva.eu/img/avatar.jpg"><title>Leveraging on SQL Server metadata</title>
<link rel=icon href=https://claudioessilva.eu/img/favicon.jpg><link rel=canonical href=https://claudioessilva.eu/2018/08/24/Leveraging-on-SQL-Server-metadata/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://claudioessilva.eu/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-27703765-1","auto"),ga("send","pageview"))</script></head><body><div id=blog><header id=header data-behavior=4><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=/ aria-label="Go to homepage">Cláudio Silva's Blog</a></div><a class=header-right-picture href=/#about aria-label="Open the link: /#about"><img class=header-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a></header><nav id=sidebar data-behavior=4><div class=sidebar-container><div class=sidebar-profile><a href=/#about aria-label="Read more about the author"><img class=sidebar-profile-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a><h4 class=sidebar-profile-name>Cláudio Silva</h4><h5 class=sidebar-profile-bio>Data Platform Architect and PowerShell lover.</h5></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/ title=Home><i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden=true></i>
<span class=sidebar-button-desc>Home</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/tags title=Tags><i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden=true></i>
<span class=sidebar-button-desc>Tags</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/#about title=About><i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden=true></i>
<span class=sidebar-button-desc>About</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://github.com/claudioessilva target=_blank rel=noopener title=GitHub><i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden=true></i>
<span class=sidebar-button-desc>GitHub</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://twitter.com/claudioessilva target=_blank rel=noopener title=Twitter><i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden=true></i>
<span class=sidebar-button-desc>Twitter</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://www.linkedin.com/in/claudioessilva target=_blank rel=noopener title=LinkedIn><i class="sidebar-button-icon fab fa-lg fa-linkedin" aria-hidden=true></i>
<span class=sidebar-button-desc>LinkedIn</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/index.xml title=RSS><i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden=true></i>
<span class=sidebar-button-desc>RSS</span></a></li></ul></div><div class=sidebar-container><div style=color:#ebebeb;font-size:25px;text-align:center>dbatools book</div><div style=color:#ebebeb;font-size:15px>Now available! Buy it at manning.com - 50% off with code bldbatools50</div><a href="https://www.manning.com/books/learn-dbatools-in-a-month-of-lunches?utm_source=claudioessilva&utm_medium=affiliate&utm_campaign=affiliate&a_aid=claudioessilva" target=_blank><center><img src=https://images.manning.com/264/352/resize/book/0/998b76f-982a-4661-a020-5d94909f7ea5/LeMaire-HI.png height=300></center></a></div></nav><div id=main data-behavior=4 class=hasCoverMetaIn><article class=post id=top><div class="post-header main-content-wrap text-left"><h1 class=post-title>Leveraging on SQL Server metadata</h1><div class="postShorten-meta post-meta"><time datetime=2018-08-24T00:00:00Z>August 24, 2018</time></div></div><div class="post-content markdown"><div class=main-content-wrap><p>I&rsquo;m working on a project where I need to convert Firebird SQL code into T-SQL code.
No schema, just the modules. There are more than 1000 objects between stored procedures, views, triggers, user-defined data types, etc.</p><h2 id=first---the-pain>First - the pain&mldr;</h2><p>While checking the <a href=https://firebirdsql.org/en/reference-manuals/>Firebird reference manuals</a> I saw a lot of different concepts (Selectable Stored Procedures - Yes you can do SELECT FROM StoredProcedure) and different functions names with different syntax compared to T-SQL.</p><p>With this in mind, can you imagine doing a code migration between two different SQL flavours that contains more than 60000 lines of code by hand? 😨</p><h3 id=andthe-false-alarm---my-approach>and&mldr;the false alarm - My approach</h3><p>When I started to think about the possible approaches to this huge amount of work I will have, one of the ideas (and actually the one I ended up doing) was write a find/replace function in PowerShell that can receive an hashtable with &ldquo;pattern to search&rdquo; and the &ldquo;pattern to replace&rdquo;.</p><p>Because the <code>-replace</code> method allows the use of regular expressions this become very powerful.</p><h4 id=dont-reinvent-the-wheel>Don&rsquo;t reinvent the wheel</h4><p>I did a search and found a <a href=https://gist.github.com/MatthewSteeples/1961d4bf4892f09d32029>gist from Matthew Steeples</a> that has a function to do a find/replace of a single string on a file using regular expressions.</p><p>I picked this script and I have adapted to my reality. This means, I have changed the code in order to:</p><ul><li>Accept an ordered hashtable and this way do multiple changes.</li><li>Open the file and do all the changes before save it again.</li></ul><p>You can find on my GitHub repository the <a href=https://github.com/ClaudioESSilva/SQLServer-PowerShell/tree/master/PowerShell/Set-Expression>Set-Expression PowerShell function</a> I ended with.</p><h4 id=filling-the-hastable>Filling the hastable</h4><p>To fill the hashtable I had to make a match between the two SQL flavours.</p><p>Just a couple of examples to ilustrate the differences:</p><p>Firebird has the <code>similar</code> function which translate to <code>LIKE '%%'</code> on T-SQL
Other example is the <code>SUBSTRING</code> function which has the following structure <code>SUBSTRING([field] from [start_position] for [number of chars])</code> which, in order to translate for T-SQL, we just need to replace the &ldquo;from&rdquo; and &ldquo;for&rdquo; words by a comma (",").</p><blockquote><p>Everything was going well, work was progressing at a good pace until&mldr;</p></blockquote><h3 id=the-pain-strikes-back>The pain strikes back</h3><p>These databases make a heavy use of triggers. The main use of it is to generate a new ID to a column based on a Firebird DOMAIN object (SEQUENCES in T-SQL) on <code>BEFORE INSERT</code> (INSTEAD OF in T-SQL) triggers.</p><p>Note: &ldquo;But they can use <code>IDENTITY</code> columns&mldr;&rdquo; - Exactly what I have proposed, and for some tables they have implemented but for the majority it wasn&rsquo;t possible.</p><p>Firebird make this somehow easy. This is a code example from an Firebird trigger:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TRIGGER</span> Customers_BI <span style=color:#66d9ef>FOR</span> Customers
</span></span><span style=display:flex><span>ACTIVE <span style=color:#66d9ef>BEFORE</span> <span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>POSITION</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>as</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>new</span>.id <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span>) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span>.id <span style=color:#f92672>=</span> gen_id(gen_Customers_id,<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>;
</span></span></code></pre></div><p>in T-SQL syntax, we need to set the whole <code>INSERT</code> statement with all columns from the <code>INSERTED</code> table. The equivalent code can be something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TRIGGER</span> dbo.Customers_BI
</span></span><span style=display:flex><span><span style=color:#66d9ef>ON</span> dbo.Customers
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSTEAD</span> <span style=color:#66d9ef>OF</span> <span style=color:#66d9ef>INSERT</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>AS</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span>
</span></span><span style=display:flex><span>            (
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>                       <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                  <span style=color:#66d9ef>FROM</span> INSERTED
</span></span><span style=display:flex><span>                 <span style=color:#66d9ef>WHERE</span> Inserted.ID <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> dbo.Customers (ID, <span style=color:#f92672>&lt;</span>other columns<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>                           <span style=color:#66d9ef>NEXT</span> VALUE <span style=color:#66d9ef>FOR</span> dbo.gen_Customers_id
</span></span><span style=display:flex><span>                         , <span style=color:#f92672>&lt;</span>other columns<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>FROM</span> INSERTED;
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>END</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>END</span>;
</span></span></code></pre></div><h3 id=so-you-need-to-replace-1-line-with-an-insert-statement-with-all-columns-from-the-table>&ldquo;so you need to replace 1 line with an <code>INSERT</code> statement with all columns from the table&mldr;&rdquo;</h3><p>Yes that much work..on almost 300 triggers! Feeling the pain, right?</p><h2 id=here-is-where-the-sql-server-metadata-joins-the-party>Here is where the SQL Server metadata joins the party!</h2><p>This is just an example, but with it you can imagine the others :-)</p><p>I wrote a piece of T-SQL (not pretty but it works) that creates, for each table, the hashtable entry for my find/replace function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>      A.<span style=color:#66d9ef>TABLE_NAME</span>
</span></span><span style=display:flex><span>    , <span style=color:#e6db74>&#39;&#39;&#39;(FOR )(\b&#39;</span> <span style=color:#f92672>+</span> A.<span style=color:#66d9ef>TABLE_NAME</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\b)((.|\r\n){1,})(\bACTIVE BEFORE INSERT POSITION 0\b)(\r\n)(AS)(\r\n)(BEGIN)(\r\n)((.|\n){1,})(gen_id\()(\w{1,})((.|\r\n)*?)(?=end;)(.*)&#39;&#39; = &#34;ON `$2`$3INSTEAD OF INSERT`$3`$7`$8`$9`$10`$11`$12 `$3INSERT INTO `$2 ( &#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> A.ColumnList <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; ) `$3SELECT NEXT VALUE FOR dbo.`$14, &#39;</span> <span style=color:#f92672>+</span> A.ColumnList <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; FROM INSERTED `$3 --`$13`$14`$15`$16`$17&#34;&#39;</span>
</span></span><span style=display:flex><span>    , <span style=color:#e6db74>&#39;&#39;&#39;(FOR )(\b&#39;</span> <span style=color:#f92672>+</span> A.<span style=color:#66d9ef>TABLE_NAME</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\b)((.|\r\n){1,})(\bACTIVE BEFORE UPDATE POSITION 0\b)(\r\n)(AS)(\r\n)(BEGIN)(\r\n)((.|\r\n){1,})((.|\r\n)*?)(?=end;)(.*)&#39;&#39; = &#34;ON `$2`$3INSTEAD OF UPDATE`$3`$7`$8`$9 `$3UPDATE `$2 `$3SET &#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> A.ColumnListUpdate <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;, `$10`$11 FROM INSERTED `$3 `$15&#34;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>      (
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>DISTINCT</span>
</span></span><span style=display:flex><span>                 ISC.<span style=color:#66d9ef>TABLE_NAME</span>
</span></span><span style=display:flex><span>               , STUFF((
</span></span><span style=display:flex><span>                           <span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>                                  <span style=color:#e6db74>&#39;, &#39;</span> <span style=color:#f92672>+</span> ISC1.<span style=color:#66d9ef>COLUMN_NAME</span>
</span></span><span style=display:flex><span>                             <span style=color:#66d9ef>FROM</span> INFORMATION_SCHEMA.COLUMNS <span style=color:#66d9ef>AS</span> ISC1
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>WHERE</span> OBJECT_ID(ISC1.<span style=color:#66d9ef>TABLE_NAME</span>) <span style=color:#f92672>=</span> OBJECT_ID(ISC.<span style=color:#66d9ef>TABLE_NAME</span>)
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> ISC1.ORDINAL_POSITION
</span></span><span style=display:flex><span>                           <span style=color:#66d9ef>FOR</span> XML PATH(<span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>                       )
</span></span><span style=display:flex><span>                     , <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                     , <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                     , <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>                      ) <span style=color:#66d9ef>AS</span> ColumnList
</span></span><span style=display:flex><span>               , STUFF((
</span></span><span style=display:flex><span>                           <span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>                                  <span style=color:#e6db74>&#39;, &#39;</span> <span style=color:#f92672>+</span> ISC1.<span style=color:#66d9ef>COLUMN_NAME</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; = &#39;</span> <span style=color:#f92672>+</span> ISC1.<span style=color:#66d9ef>COLUMN_NAME</span>
</span></span><span style=display:flex><span>                             <span style=color:#66d9ef>FROM</span> INFORMATION_SCHEMA.COLUMNS <span style=color:#66d9ef>AS</span> ISC1
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>WHERE</span> OBJECT_ID(ISC1.<span style=color:#66d9ef>TABLE_NAME</span>) <span style=color:#f92672>=</span> OBJECT_ID(ISC.<span style=color:#66d9ef>TABLE_NAME</span>)
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> ISC1.ORDINAL_POSITION
</span></span><span style=display:flex><span>                           <span style=color:#66d9ef>FOR</span> XML PATH(<span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>                       )
</span></span><span style=display:flex><span>                     , <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                     , <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                     , <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>                      ) <span style=color:#66d9ef>AS</span> ColumnListUpdate
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>FROM</span> INFORMATION_SCHEMA.COLUMNS <span style=color:#66d9ef>AS</span> ISC
</span></span><span style=display:flex><span>                 <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> sys.sysobjects <span style=color:#66d9ef>AS</span> so
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>ON</span> ISC.<span style=color:#66d9ef>TABLE_NAME</span> <span style=color:#f92672>=</span> so.name
</span></span><span style=display:flex><span>                   <span style=color:#66d9ef>AND</span> so.<span style=color:#66d9ef>type</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;U&#39;</span>
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>WHERE</span> ISC.<span style=color:#66d9ef>TABLE_NAME</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>IN</span> (<span style=color:#e6db74>&#39;sysdiagrams&#39;</span>, <span style=color:#e6db74>&#39;Numbers&#39;</span>)
</span></span><span style=display:flex><span>      ) <span style=color:#66d9ef>AS</span> A
</span></span><span style=display:flex><span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> A.<span style=color:#66d9ef>TABLE_NAME</span>;
</span></span></code></pre></div><p>Let&rsquo;s say I have a <code>Customers</code> table with 3 columns <code>ID, NAME, COMPANY_NAME</code> the output will be:
<img src=/img/2018/08/output_triggers.png alt=output_triggers></p><p>Example of the full string for the INSTEAD OF INSERT trigger:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#e6db74>&#39;(FOR )(\bCustomers\b)((.|\r\n){1,})(\bACTIVE BEFORE INSERT POSITION 0\b)(\r\n)(AS)(\r\n)(BEGIN)(\r\n)((.|\n){1,})(gen_id\()(\w{1,})((.|\r\n)*?)(?=end;)(.*)&#39;</span> = <span style=color:#e6db74>&#34;ON </span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>2</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>3INSTEAD OF INSERT</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>3</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>7</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>8</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>9</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>10</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>11</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>12 </span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>3INSERT INTO </span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>2 (  ID, NAME, COMPANY_NAME ) </span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>3SELECT NEXT VALUE FOR dbo.</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>14,  ID, NAME, COMPANY_NAME FROM INSERTED </span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>3 --</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>13</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>14</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>15</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>16</span><span style=color:#ae81ff>`$</span><span style=color:#e6db74>17&#34;</span>`
</span></span></code></pre></div><p>This way I can just copy/paste the result to my hashtable and run the PowerShell function on my triggers&rsquo; files.</p><h3 id=alls-well-that-ends-well>All&rsquo;s well that ends well</h3><p>This made possible to automate, I would say, 95% of the work I have to do on each trigger object.</p><p>The 5% left are purposeful and intended to format the code using <a href=https://www.red-gate.com/products/sql-development/sql-prompt/index>Redgate SQL Prompt</a> (formatted the code using the great <code>CTRL + K, Y</code> shortcut) once I open the script on SQL Server Management Studio and test the object compilation.</p><h4 id=other-examples>Other examples?</h4><p>I applied the same recipe on scripts with user-defined data types (UDDT). I picked the system data type and created entries to the hashtable with the proper replace.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#39;&#39;&#39;\b&#39;</span> <span style=color:#f92672>+</span> T2.name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;\b&#39;&#39; = &#34;&#39;</span> <span style=color:#f92672>+</span> T1.name <span style=color:#f92672>+</span> <span style=color:#66d9ef>CASE</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#66d9ef>WHEN</span> T2.system_type_id <span style=color:#66d9ef>IN</span> (<span style=color:#ae81ff>231</span>, <span style=color:#ae81ff>239</span>) <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;(&#39;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>CASE</span>
</span></span><span style=display:flex><span>                                                                                                         <span style=color:#66d9ef>WHEN</span> T2.max_length <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;MAX&#39;</span>
</span></span><span style=display:flex><span>                                                                                                         <span style=color:#66d9ef>ELSE</span> <span style=color:#66d9ef>CAST</span>(T2.max_length <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span> <span style=color:#66d9ef>AS</span> VARCHAR(<span style=color:#ae81ff>10</span>))
</span></span><span style=display:flex><span>                                                                                                     <span style=color:#66d9ef>END</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;)&#39;</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#66d9ef>WHEN</span> T2.system_type_id <span style=color:#66d9ef>IN</span> (<span style=color:#ae81ff>175</span>, <span style=color:#ae81ff>167</span>) <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;(&#39;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>CASE</span>
</span></span><span style=display:flex><span>                                                                                                         <span style=color:#66d9ef>WHEN</span> T2.max_length <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>THEN</span> <span style=color:#e6db74>&#39;MAX&#39;</span>
</span></span><span style=display:flex><span>                                                                                                         <span style=color:#66d9ef>ELSE</span> <span style=color:#66d9ef>CAST</span>(T2.max_length <span style=color:#66d9ef>AS</span> VARCHAR(<span style=color:#ae81ff>10</span>))
</span></span><span style=display:flex><span>                                                                                                     <span style=color:#66d9ef>END</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;)&#39;</span>
</span></span><span style=display:flex><span>                                                     <span style=color:#66d9ef>ELSE</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>                                                 <span style=color:#66d9ef>END</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;&#34;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> sys.types <span style=color:#66d9ef>AS</span> T1
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> sys.types <span style=color:#66d9ef>AS</span> T2
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>ON</span> T1.user_type_id <span style=color:#f92672>=</span> T2.system_type_id
</span></span><span style=display:flex><span> <span style=color:#66d9ef>WHERE</span> T2.user_type_id <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>256</span>;
</span></span></code></pre></div><h5 id=practical-example>Practical example:</h5><p>UDDT named <code>INT_VALUE</code>, that represents an INT, used in the following way <code>CAST(column AS INT_VALUE)</code> needs to be replaced as
<code>CAST(column as INT)</code>.</p><p>Why we need to do this replace? I have written about it on my blog post <a href=https://claudioessilva.eu/2018/05/02/using-cast-function-with-user-defined-data-types-did-you-know/>Using CAST() function with User-Defined Data Types…Did you know…</a> take a look.</p><h2 id=wrap-up---life-saver-and-time-saved>Wrap up - Life saver and time saved</h2><p>Leverage on SQL Server metadata to generate quick code and use it inside SQL Server or outside like I did it here!</p><p>I did some math and I have estimated that I would need several months to finish this task doing everything by hand.</p><p>Everything could go wrong doing that way:</p><ul><li>This is an heavely repetitive task</li><li>highly prone to errors</li><li>a witch hunt when problems arise</li></ul><p>After all, with this approach I have made in <strong>less than one month</strong>! And, half of those days were to tweak the regular expressions/hashtable.</p><p>Automation? You gotta to love it! :-)</p><p>Thanks for reading!</p></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-footer-tags><span class="text-color-light text-small">TAGGED IN</span><br><a class="tag tag--primary tag--small" href=/tags/Automation/>Automation</a>
<a class="tag tag--primary tag--small" href=/tags/Firebird/>Firebird</a>
<a class="tag tag--primary tag--small" href=/tags/Metadata/>Metadata</a>
<a class="tag tag--primary tag--small" href=/tags/PowerShell/>PowerShell</a>
<a class="tag tag--primary tag--small" href=/tags/SQL-Server/>SQL Server</a>
<a class="tag tag--primary tag--small" href=/tags/SQLPrompt/>SQLPrompt</a>
<a class="tag tag--primary tag--small" href=/tags/SQLServer/>SQLServer</a>
<a class="tag tag--primary tag--small" href=/tags/syndicated/>syndicated</a></div><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2018/09/04/Dont-cutoff-yourself-with-dates-in-T-SQL-Did-you-know.../ data-tooltip="Don't cutoff yourself with dates in T-SQL - Did you know..." aria-label="NEXT: Don't cutoff yourself with dates in T-SQL - Did you know..."><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2018/07/06/I-will-be-speaking-@-Tuga-IT-2018/ data-tooltip="I will be speaking @ Tuga IT 2018" aria-label="PREVIOUS: I will be speaking @ Tuga IT 2018"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2018/08/24/Leveraging-on-SQL-Server-metadata/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2018/08/24/Leveraging-on-SQL-Server-metadata/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2018/08/24/Leveraging-on-SQL-Server-metadata/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div><div class=comments><script src=https://utteranc.es/client.js repo=ClaudioESSilva/blog-comments issue-term=og:title theme=github-light crossorigin=anonymous async></script></div></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2024 Cláudio Silva. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=4><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2018/09/04/Dont-cutoff-yourself-with-dates-in-T-SQL-Did-you-know.../ data-tooltip="Don't cutoff yourself with dates in T-SQL - Did you know..." aria-label="NEXT: Don't cutoff yourself with dates in T-SQL - Did you know..."><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2018/07/06/I-will-be-speaking-@-Tuga-IT-2018/ data-tooltip="I will be speaking @ Tuga IT 2018" aria-label="PREVIOUS: I will be speaking @ Tuga IT 2018"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2018/08/24/Leveraging-on-SQL-Server-metadata/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2018/08/24/Leveraging-on-SQL-Server-metadata/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2018/08/24/Leveraging-on-SQL-Server-metadata/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div></div><div id=share-options-bar class=share-options-bar data-behavior=4><i id=btn-close-shareoptions class="fa fa-times"></i><ul class=share-options><li class=share-option><a class=share-option-btn target=new href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fclaudioessilva.eu%2F2018%2F08%2F24%2FLeveraging-on-SQL-Server-metadata%2F" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i><span>Share on Facebook</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fclaudioessilva.eu%2F2018%2F08%2F24%2FLeveraging-on-SQL-Server-metadata%2F" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i><span>Share on Twitter</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fclaudioessilva.eu%2F2018%2F08%2F24%2FLeveraging-on-SQL-Server-metadata%2F" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i><span>Share on Linkedin</span></a></li></ul></div><div id=share-options-mask class=share-options-mask></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-times"></i></div><img id=about-card-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"><h4 id=about-card-name>Cláudio Silva</h4><div id=about-card-bio>Data Platform Architect and PowerShell lover.</div><div id=about-card-job><i class="fa fa-briefcase"></i><br>Data Platform Architect</div><div id=about-card-location><i class="fa fa-map-marker-alt"></i><br>Portugal</div></div></div><div id=cover style=background-image:url(https://claudioessilva.eu/images/cover_bridge.jpg)></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://claudioessilva.eu/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js></script><script>$(document).ready(function(){hljs.configure({classPrefix:"",useBR:!1}),$("pre.code-highlight > code, pre > code").each(function(e,t){$(this).hasClass("codeblock")||$(this).addClass("codeblock"),hljs.highlightBlock(t)})})</script></body></html>