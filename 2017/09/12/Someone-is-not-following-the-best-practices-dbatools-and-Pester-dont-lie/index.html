<!doctype html><html lang=en-us><head><script type=application/ld+json>{"@context":"http://schema.org","@type":"Website","@id":"https:\/\/claudioessilva.eu","author":{"@type":"Person","name":"Cláudio Silva","image":"https://claudioessilva.eu/img/avatar.jpg"},"name":"Cláudio Silva\u0027s Blog","description":"This month’s T-SQL Tuesday is brought to us by my good friend Rob Sewell (b | t). Together “Let’s get all Posh – What are you going to automate today?”\nI have written some blog posts on how I use PowerShell to automate mundane tasks or some other more complex scenarios like: Find and fix SQL Server databases with empty owner property using dbatools PowerShell module or Have you backed up your SQL Logins today?","url":"https:\/\/claudioessilva.eu\/2017\/09\/12\/Someone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie\/","keywords":"[]"}</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.101.0 with theme Tranquilpeak 0.5.3-BETA"><meta name=author content="Cláudio Silva"><meta name=keywords content><meta name=description content="This month’s T-SQL Tuesday is brought to us by my good friend Rob Sewell (b | t). Together “Let’s get all Posh – What are you going to automate today?”
I have written some blog posts on how I use PowerShell to automate mundane tasks or some other more complex scenarios like: Find and fix SQL Server databases with empty owner property using dbatools PowerShell module or Have you backed up your SQL Logins today?"><meta property="og:description" content="This month’s T-SQL Tuesday is brought to us by my good friend Rob Sewell (b | t). Together “Let’s get all Posh – What are you going to automate today?”
I have written some blog posts on how I use PowerShell to automate mundane tasks or some other more complex scenarios like: Find and fix SQL Server databases with empty owner property using dbatools PowerShell module or Have you backed up your SQL Logins today?"><meta property="og:type" content="article"><meta property="og:title" content="Someone is not following the best practices - dbatools and Pester don't lie!"><meta name=twitter:title content="Someone is not following the best practices - dbatools and Pester don't lie!"><meta property="og:url" content="https://claudioessilva.eu/2017/09/12/Someone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie/"><meta property="twitter:url" content="https://claudioessilva.eu/2017/09/12/Someone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie/"><meta property="og:site_name" content="Cláudio Silva's Blog"><meta property="og:description" content="This month’s T-SQL Tuesday is brought to us by my good friend Rob Sewell (b | t). Together “Let’s get all Posh – What are you going to automate today?”
I have written some blog posts on how I use PowerShell to automate mundane tasks or some other more complex scenarios like: Find and fix SQL Server databases with empty owner property using dbatools PowerShell module or Have you backed up your SQL Logins today?"><meta name=twitter:description content="This month’s T-SQL Tuesday is brought to us by my good friend Rob Sewell (b | t). Together “Let’s get all Posh – What are you going to automate today?”
I have written some blog posts on how I use PowerShell to automate mundane tasks or some other more complex scenarios like: Find and fix SQL Server databases with empty owner property using dbatools PowerShell module or Have you backed up your SQL Logins today?"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2017-09-12T00:00:00"><meta property="article:modified_time" content="2017-09-12T00:00:00"><meta property="article:tag" content="BestPractices"><meta property="article:tag" content="dbatools"><meta property="article:tag" content="Pester"><meta property="article:tag" content="PowerShell"><meta property="article:tag" content="SQLServer"><meta property="article:tag" content="syndicated"><meta property="article:tag" content="Tests"><meta property="article:tag" content="Unit Test"><meta property="article:tag" content="TSQL2sDay"><meta name=twitter:card content="summary"><meta name=twitter:site content="@claudioessilva"><meta name=twitter:creator content="@claudioessilva"><meta property="og:image" content="https://claudioessilva.eu/img/avatar.jpg"><meta property="twitter:image" content="https://claudioessilva.eu/img/avatar.jpg"><title>Someone is not following the best practices - dbatools and Pester don't lie!</title><link rel=icon href=https://claudioessilva.eu/img/favicon.jpg><link rel=canonical href=https://claudioessilva.eu/2017/09/12/Someone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://claudioessilva.eu/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-27703765-1","auto"),ga("send","pageview"))</script></head><body><div id=blog><header id=header data-behavior=4><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=/ aria-label="Go to homepage">Cláudio Silva's Blog</a></div><a class=header-right-picture href=/#about aria-label="Open the link: /#about"><img class=header-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a></header><nav id=sidebar data-behavior=4><div class=sidebar-container><div class=sidebar-profile><a href=/#about aria-label="Read more about the author"><img class=sidebar-profile-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a><h4 class=sidebar-profile-name>Cláudio Silva</h4><h5 class=sidebar-profile-bio>Data Platform Architect and PowerShell lover.</h5></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/ title=Home><i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden=true></i>
<span class=sidebar-button-desc>Home</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/tags title=Tags><i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden=true></i>
<span class=sidebar-button-desc>Tags</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/#about title=About><i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden=true></i>
<span class=sidebar-button-desc>About</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://github.com/claudioessilva target=_blank rel=noopener title=GitHub><i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden=true></i>
<span class=sidebar-button-desc>GitHub</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://twitter.com/claudioessilva target=_blank rel=noopener title=Twitter><i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden=true></i>
<span class=sidebar-button-desc>Twitter</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://www.linkedin.com/in/claudioessilva target=_blank rel=noopener title=LinkedIn><i class="sidebar-button-icon fab fa-lg fa-linkedin" aria-hidden=true></i>
<span class=sidebar-button-desc>LinkedIn</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/index.xml title=RSS><i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden=true></i>
<span class=sidebar-button-desc>RSS</span></a></li></ul></div><div class=sidebar-container><div style=color:#ebebeb;font-size:25px;text-align:center>dbatools book</div><div style=color:#ebebeb;font-size:15px>Now available! Buy it at manning.com - 50% off with code bldbatools50</div><a href="https://www.manning.com/books/learn-dbatools-in-a-month-of-lunches?utm_source=claudioessilva&utm_medium=affiliate&utm_campaign=affiliate&a_aid=claudioessilva" target=_blank><center><img src=https://images.manning.com/264/352/resize/book/0/998b76f-982a-4661-a020-5d94909f7ea5/LeMaire-HI.png height=300></center></a></div></nav><div id=main data-behavior=4 class=hasCoverMetaIn><article class=post id=top><div class="post-header main-content-wrap text-left"><h1 class=post-title>Someone is not following the best practices - dbatools and Pester don't lie!</h1><div class="postShorten-meta post-meta"><time datetime=2017-09-12T00:00:00Z>September 12, 2017</time></div></div><div class="post-content markdown"><div class=main-content-wrap><p><a href=https://sqldbawithabeard.com/2017/09/05/tsql2sday-94-lets-get-all-posh/><img src=/img/2017/09/tsql2sday.jpg alt=(TSQL2sDay)></a></p><p>This month’s T-SQL Tuesday is brought to us by my good friend Rob Sewell (<a href=https://twitter.com/sqldbawithbeard>b</a> | <a href=https://sqldbawithabeard.com>t</a>). Together “Let’s get all Posh – What are you going to automate today?”</p><p>I have written some blog posts on how I use PowerShell to automate mundane tasks or some other more complex scenarios like:  <a href=http://redglue.org/find-and-fix-sql-server-databases-with-empty-owner-property-using-dbatools-powershell-module/>Find and fix SQL Server databases with empty owner property using dbatools PowerShell module</a> or <a href=http://redglue.org/have-you-backed-up-your-sql-logins-today/>Have you backed up your SQL Logins today?</a>  or even using ReportingServicesTools module for deploy reports - <a href=http://redglue.org/ssrs-report-deployment-made-easy-700-times-faster/>SSRS Report Deployment Made Easy – 700 times Faster</a>.</p><p>But today I want to bring something little different.  This year, back in May I saw two presentations from Rob about using Pester to do unit tests for our PowerShell code and also to validate options/infrastructure like checklists. This got my attention and made me want to play with it!</p><p>Therefore, I want to share an example with you using two of my favorite PowerShell modules dbatools and Pester.</p><h2 id=lets-play-a-game>Let&rsquo;s play a game</h2><p>You go to a client or you have just started working on your new employer and you want to know if the entire SQL Server state complies with the best practices.</p><p>For the propose of this blog, we will check:</p><ul><li><p>if our databases (from all instances) have the following configurations:</p><ul><li>PageVerify -> Checksum</li><li>AutoShrink -> False</li></ul></li><li><p>if each SQL Server instance:</p><ul><li>has the MaxMemory setting configured to a value lower than the total existing memory on the host.</li></ul></li></ul><p>How would you do that?</p><h3 id=let-me-introduce-to-you---dbatools>Let me introduce to you - dbatools</h3><p>For those who don’t know, <a href=https://github.com/sqlcollaborative/dbatools/>dbatools is a PowerShell module</a>, written by the community, that makes SQL Server administration much easier using PowerShell. Today, the module has more than 260 commands. Go get it (<a href=http://dbatools.io>dbatools.io</a>) and try it! If you have any doubt you can join the team on the #dbatools channel at the <a href=https://dbatools.io/slack>Slack – SQL Server Community</a>.</p><p>In this post I will show some of those commands and how they can help us.</p><p>Disclaimer: Obviously this <strong>is not the only way to accomplish this request, but for me, is one excellent way!</strong></p><h3 id=get-dbadatabase-command>Get-DbaDatabase command</h3><p>One existing command on the dbatools swiss army knife is <a href=https://dbatools.io/functions/get-dbadatabase/>Get-DbaDatabase</a>.
As it states on the command description</p><blockquote><p>The Get-DbaDatabase command gets SQL database information for each database that is present in the target instance(s) of SQL Server. If the name of the database is provided, the command will return only the specific database information.
This means that I can run the following piece of PowerShell code and get some information about my databases:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-DbaDatabase -SqlServer sql2016 | Format-Table
</span></span></code></pre></div><p>This returns the following information from all existing databases on this SQL2016 instance.</p><p><img src="/img/2017/09/get-dbadatabase_sql2016_ft.png?w=656" alt=get-dbadatabase_sql2016_ft></p><h4 id=too-little-information>Too little information</h4><p>That&rsquo;s true, when we look to it, it brings not enough information. I can&rsquo;t even get the &ldquo;PageVerify&rdquo; and &ldquo;AutoShrink&rdquo; properties that I want. But that is because we, by default, only output a bunch of properties and this doesn&rsquo;t mean that the others are not there.</p><p>To confirm this we can run the same code without the " | Format-Table" that is useful to output the information in a table format but depending on the size of your window it can show more or less columns.
By running the command without the &ldquo;format-table&rdquo; we can see the following (just showing the first 3 databases):</p><p><img src=/img/2017/09/get-dbadatabase_sql2016_without_ft2.png alt=get-dbadatabase_sql2016_without_ft2></p><p>Now, we can see more properties available look to the ones inside the red rectangle.</p><h4 id=i-continue-not-to-see-the-ones-i-want>I continue not to see the ones I want</h4><p>You are right. But as I said before that does not means they aren&rsquo;t there.
To simplify the code let&rsquo;s assign our output to a variable named <code>$databases</code> and then we will have a look to all the Members existing on this object</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$databases = Get-DbaDatabase -SqlServer sql2016
</span></span><span style=display:flex><span>$databases | Get-Member
</span></span></code></pre></div><p>Now we get a lot of stuff! The <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/get-member?view=powershell-5.1">Get-Member cmdlet</a> say to us which Properties and Methods of the object (in this case the <code>$databases</code>).</p><p>This means that I can use a filter to find results with &ldquo;auto&rdquo; in its name:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$databases | Get-Member | Where-Object Name <span style=color:#f92672>-like</span> *auto*
</span></span></code></pre></div><p>Some cmdlets have parameters that allow us to filter information without the need to pipeing it so, the last line command could be written as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$databases | Get-Member -Name *auto*
</span></span></code></pre></div><p>Which will output something like this:</p><p><img src="/img/2017/09/databases_gm_whereauto.png?w=656" alt=databases_gm_whereauto></p><p>So, we have found our &ldquo;AutoShrink&rdquo; property. With this in mind, lets query all the properties we want.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$databases | Select-Object SqlInstance, Name, AutoShrink, PageVerify
</span></span></code></pre></div><p>And here we have the result:</p><p><img src="/img/2017/09/databases_data.png?w=656" alt=databases_data></p><h3 id=scaling-for-multiple-instances>Scaling for multiple instances</h3><p>This is where the fun begins.
We can pass multiple instance names and the command will go through all of them and output a single object with the data.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$databases = Get-DbaDatabase -SqlServer sql2016, sql2012
</span></span><span style=display:flex><span>$databases | Select-Object SqlInstance, Name, AutoShrink, PageVerify
</span></span></code></pre></div><p>Which outputs:</p><p><img src="/img/2017/09/get-dbadatabase_sql2016_sql20121.png?w=656" alt=get-dbadatabase_sql2016_sql20121></p><p>As you can see I have passed two different instances sql2016 (in red) and sql2012 (in green) and the output brought both information.</p><h3 id=using-out-gridview-to-filter-results>Using Out-GridView to filter results</h3><p>We can use another PowerShell native cmdlet called <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/out-gridview?view=powershell-5.1">Out-GridView</a> to show our results in a grid format. This grid also make it possible to use filters.
For the next example, I have misconfigurated two databases so we can find them among the others.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$databases | Select-Object SqlInstance, Name, AutoShrink, PageVerify | Out-GridView
</span></span></code></pre></div><p><img src="/img/2017/09/databases_data_ogv.png?w=656" alt=databases_data_ogv></p><p>As you can see, inside red rectangles we have two not optimal configurations regarding the SQL Server best practices. You can also see the green rectangle on the top left corner where you can type text and the results will be filter as you type. So if you type &ldquo;true&rdquo; you will end just with one record.</p><p><img src="/img/2017/09/databases_data_ogv_filter.png?w=656" alt=databases_data_ogv_filter></p><h3 id=checking-the-maxmemory-configuration>Checking the MaxMemory configuration</h3><p>Now, that you have seen how to do it for one command, you can start exploring the other ones. As I said in the beginning of this post we will also check the MaxMemory setting for each instance. We will use the <a href=https://dbatools.io/functions/get-dbamaxmemory/>Get-DbaMaxMemory</a>. From the help page we can see the description that says:</p><blockquote><p>This command retrieves the SQL Server ‘Max Server Memory’ configuration setting as well as the total physical installed on the server.
Let&rsquo;s run it through our two instances:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-DbaMaxMemory -SqlInstance sql2012, sql2016
</span></span></code></pre></div><p><img src=/img/2017/09/get-dbamaxmemory_2instances.png alt=get-dbamaxmemory_2instances></p><p>We can see that SQL2012 instance is running on a host with 6144MB of total memory but its MaxMemory setting is set to 3072MB and also, SQL2016 instance has 4608MB configured form the 18423MB existing on the host.</p><h2 id=final-thought-on-this-fast-introduction-to-dbatools-powershell-module>Final thought on this fast introduction to dbatools PowerShell module</h2><p>As you see, it is pretty easy to run the commands for one or multiple instances to get information to work on. Also you have seen different ways to output that information.
I encourage you to use the <a href=https://dbatools.io/functions/find-dbacommand/>Find-DbaCommand</a> to discover what other commands exists and what they can do for you.</p><p>Example, if you want to know which commands we have that works with &ldquo;memory&rdquo; you can run the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Find-DbaCommand -Pattern memory
</span></span></code></pre></div><p><img src="/img/2017/09/find-dbacommand.png?w=656" alt=find-dbacommand></p><h2 id=automating-even-more>Automating even more</h2><p>Using the dbatools module we could verify if the best practice is in place or not. But we had to run the command and then verify the values by filtering and looking for each row.</p><p>You may be thinking that must exists some other more automated method to accomplish that, right?</p><h3 id=say-hello-to-pester-powershell-module>Say hello to Pester PowerShell module</h3><p><a href=https://github.com/pester/Pester>Pester</a> is unit test framework for PowerShell. I like to say <em>If you can PowerShell it, you can Pester it</em>.</p><blockquote><p>Pester provides a framework for running Unit Tests to execute and validate PowerShell commands. Pester follows a file naming convention for naming tests to be discovered by pester at test time and a simple set of functions that expose a Testing DSL for isolating, running, evaluating and reporting the results of PowerShell commands.
Please see <a href=https://github.com/pester/Pester/wiki/Installation-and-Update>how to install Pester module here</a>.</p></blockquote><p>With this framework, that I really encourage you to read more about it on the <a href=https://github.com/pester/Pester/wiki/Pester>project Wiki</a>, we can automate our tests and make it do the validations for us!</p><p>As quick example - if we run the following code:</p><p>We are checking if the login returned by the <code>whoami</code> is base\claudio.</p><p><img src=/img/2017/09/pester_whoami_ok.png alt=pester_whoami_ok></p><p>This return green which means it&rsquo;s ok!</p><p>If is not ok (because I&rsquo;m testing to &ldquo;base\claudio.silva&rdquo;), will retrieve something like this:</p><p><img src="/img/2017/09/pester_whoami_nok.png?w=656" alt=pester_whoami_nok></p><h3 id=quick-walkthrough-on-pester-syntax>Quick walkthrough on Pester syntax</h3><p>As you can see, to do a test we need a:</p><ul><li>Describe block (attention: the &ldquo;{&rdquo; must be on the same line!)</li><li>Inside it, the Context block</li><li>And inside the Context block the validation that we want to do the It and Should.</li></ul><h3 id=lets-join-forces>Let&rsquo;s join forces</h3><p>With this in mind, I can create tests for my needs using dbatools and Pester.</p><p>I will have a variable (<code>$SQLServers</code>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$SQLServers = @(<span style=color:#e6db74>&#39;sql2012&#39;</span>, <span style=color:#e6db74>&#39;sql2014&#39;</span>, <span style=color:#e6db74>&#39;sql2016&#39;</span>)
</span></span></code></pre></div><p>with all the instances I want to test and two &ldquo;Describe&rdquo; blocks, one for &ldquo;Testing database options&rdquo; - PageVerify and AutoShrink</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Describe <span style=color:#e6db74>&#34;Testing Database Options for $Server&#34;</span> {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>foreach</span>($Server <span style=color:#66d9ef>in</span> $SQLServers){
</span></span><span style=display:flex><span>      <span style=color:#75715e>#Just selecting some columns so it don&#39;t take too much time returning all the thing that we don&#39;t want</span>
</span></span><span style=display:flex><span>      $databases = Get-DbaDatabase -SqlServer $server | Select-Object Name, SqlInstance, CompatibilityLevel, PageVerify, AutoShrink, AutoClose
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>foreach</span>($database <span style=color:#66d9ef>in</span> $databases) {
</span></span><span style=display:flex><span>         Context <span style=color:#e6db74>&#34;</span>$($Database.Name)<span style=color:#e6db74> Validation&#34;</span> {
</span></span><span style=display:flex><span>            It <span style=color:#e6db74>&#34;PageVerfiy set to Checksum&#34;</span> {
</span></span><span style=display:flex><span>               $database.PageVerify| Should Be <span style=color:#e6db74>&#34;Checksum&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            It <span style=color:#e6db74>&#34;AutoShrink set to False&#34;</span> {
</span></span><span style=display:flex><span>               $database.AutoShrink| Should Be $false
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And another one for &ldquo;Testing instance MaxMemory&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Describe <span style=color:#e6db74>&#34;Testing Instance MaxMemory&#34;</span>{
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>foreach</span>($Server <span style=color:#66d9ef>in</span> $SQLServers){
</span></span><span style=display:flex><span>      $instanceMemory = Get-DbaMaxMemory -SqlInstance $Server
</span></span><span style=display:flex><span>      Context <span style=color:#e6db74>&#34;Checking MaxMemory value&#34;</span> {
</span></span><span style=display:flex><span>         It <span style=color:#e6db74>&#34;</span>$($Server)<span style=color:#e6db74> instance MaxMemory value </span>$($instanceMemory.SqlMaxMb)<span style=color:#e6db74> is less than host total memory </span>$($instanceMemory.TotalMB)<span style=color:#e6db74>&#34;</span> {
</span></span><span style=display:flex><span>            $instanceMemory.SqlMaxMb | Should BeLessThan $instanceMemory.TotalMB
</span></span><span style=display:flex><span>         }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To run this tests we should save a file with the &ldquo;.Tests.ps1&rdquo; ending name. Let&rsquo;s save as &ldquo;SQLServerBestPractices.Tests.ps1&rdquo;. To run the tests we need to use the Invoke-Pester and the file that contains the tests.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Invoke-Pester .\SQLServerBestPractices.Tests.ps1
</span></span></code></pre></div><p><img src="/img/2017/09/pester_tests_with_fails.png?w=656" alt=pester_tests_with_fails></p><h3 id=to-much-noise---cant-find-the-failed-tests-easily>To much noise - can&rsquo;t find the failed tests easily</h3><p>You are right, showing all the greens make us lose the possible red ones. But Pester has an option to show just the failed tests.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Invoke-Pester .\SQLServerBestPractices.Tests.ps1 -Show Failed
</span></span></code></pre></div><p><img src="/img/2017/09/pester_tests_with_show_failed_only.png?w=656" alt=pester_tests_with_show_failed_only></p><p>But, be aware that <code>-Show Fails</code> can be a better solution, specially when you are working with multiple Tests.ps1 files.</p><p><img src=/2017/09/pester_tests_with_fails_summary_value.png alt=pester_tests_with_fails_summary_value></p><p>This way you can see where your error come from.</p><h3 id=reading-and-fixing-the-errors>Reading and fixing the errors</h3><p>As you can read from the last image from <code>-Show Failed</code> execution, the database &ldquo;dbft&rdquo; on &ldquo;SQL2016&rdquo; instance has the &ldquo;AutoShrink&rdquo; property set to &ldquo;True&rdquo; but we expect the value &ldquo;False&rdquo;. Now you can go to the database properties and change this value!</p><p>Also, the &ldquo;PageVerify&rdquo; value that we expect to be &ldquo;Checksum&rdquo; is &ldquo;TornPageDetection&rdquo; for the database &ldquo;dumpsterfire4&rdquo; and &ldquo;SQL2016&rdquo; instance.</p><p>Finally the MaxMemory configuration on the &ldquo;SQL2016&rdquo; instance is set to 46080MB (45GB) but we expect that should be less than 18432mb (18GB) that is the total memory of the host. We need to reconfigure this value too.</p><h3 id=this-is-great>This is great!</h3><p>Yes it is! Now when a new database is born on an existing instance, or you update your instances with a new one, you can simply run the tests and the new stuff will be included on this set of tests!</p><p>If you set it to run daily or even once per week you can check your estate and get new stuff that haven&rsquo;t been you to setup and maybe is not following the best practices.</p><p>Get the fails and email them (I will blog about it).</p><h3 id=next-steps>Next steps</h3><ul><li><p>Explore Pester syntax.</p></li><li><p>Add new instances.</p></li><li><p>Add new tests</p></li><li><p>Check if you have access to the instance (great way to know quickly if some instance is stopped)</p></li><li><p>Check if your backups are running with success and within our policy time interval</p></li></ul><p>You name it!</p><h2 id=want-more>Want more?</h2><p>I hope you have seen some new stuff and get some ideas from this blog post!</p><p>If you want to know if there will be some dbatools presentations near you, visit our <a href=https://dbatools.io/presentations/>presentation page</a>. You can find some of our presentations on our <a href=https://dbatools.io/youtube>youtube channel</a> and code example on the <a href=https://github.com/sqlcollaborative/community-presentations>community presentations on GitHub</a>.</p><p>About Pester and other examples and use cases, we have the <a href=https://github.com/pester/Pester/wiki/Articles-and-other-resources>Articles and other resources</a> page maintained by the Pester team.</p><p>I&rsquo;m looking forward to read the other blog posts (follow the comments on Rob&rsquo;s post, or the roundup later) on this month&rsquo;s T-SQL Tuesdays and see what people is being doing with PowerShell.</p><p>Thanks for reading.</p></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-footer-tags><span class="text-color-light text-small">TAGGED IN</span><br><a class="tag tag--primary tag--small" href=/tags/BestPractices/>BestPractices</a>
<a class="tag tag--primary tag--small" href=/tags/dbatools/>dbatools</a>
<a class="tag tag--primary tag--small" href=/tags/Pester/>Pester</a>
<a class="tag tag--primary tag--small" href=/tags/PowerShell/>PowerShell</a>
<a class="tag tag--primary tag--small" href=/tags/SQLServer/>SQLServer</a>
<a class="tag tag--primary tag--small" href=/tags/syndicated/>syndicated</a>
<a class="tag tag--primary tag--small" href=/tags/Tests/>Tests</a>
<a class="tag tag--primary tag--small" href=/tags/Unit-Test/>Unit Test</a>
<a class="tag tag--primary tag--small" href=/tags/TSQL2sDay/>TSQL2sDay</a></div><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2017/09/14/PowerShell-From-20-minutes-to-20-seconds-Change-domain-user-password-on-multiple-domains-without-login-into-each-one/ data-tooltip="[PowerShell] From 20 minutes to 20 seconds - Change domain user password on multiple domains without login into each one" aria-label="NEXT: [PowerShell] From 20 minutes to 20 seconds - Change domain user password on multiple domains without login into each one"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2017/09/07/Invalid-class-0x80041010-error-when-trying-to-access-SQLServers-WMI-classes/ data-tooltip="'Invalid class [0x80041010]' error when trying to access SQLServer's WMI classes" aria-label="PREVIOUS: 'Invalid class [0x80041010]' error when trying to access SQLServer's WMI classes"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2017/09/12/Someone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2017/09/12/Someone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2017/09/12/Someone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div><div class=comments><script src=https://utteranc.es/client.js repo=ClaudioESSilva/blog-comments issue-term=og:title theme=github-light crossorigin=anonymous async></script></div></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2022 Cláudio Silva. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=4><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2017/09/14/PowerShell-From-20-minutes-to-20-seconds-Change-domain-user-password-on-multiple-domains-without-login-into-each-one/ data-tooltip="[PowerShell] From 20 minutes to 20 seconds - Change domain user password on multiple domains without login into each one" aria-label="NEXT: [PowerShell] From 20 minutes to 20 seconds - Change domain user password on multiple domains without login into each one"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2017/09/07/Invalid-class-0x80041010-error-when-trying-to-access-SQLServers-WMI-classes/ data-tooltip="'Invalid class [0x80041010]' error when trying to access SQLServer's WMI classes" aria-label="PREVIOUS: 'Invalid class [0x80041010]' error when trying to access SQLServer's WMI classes"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2017/09/12/Someone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2017/09/12/Someone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2017/09/12/Someone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div></div><div id=share-options-bar class=share-options-bar data-behavior=4><i id=btn-close-shareoptions class="fa fa-times"></i><ul class=share-options><li class=share-option><a class=share-option-btn target=new href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fclaudioessilva.eu%2F2017%2F09%2F12%2FSomeone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie%2F" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i><span>Share on Facebook</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fclaudioessilva.eu%2F2017%2F09%2F12%2FSomeone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie%2F" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i><span>Share on Twitter</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fclaudioessilva.eu%2F2017%2F09%2F12%2FSomeone-is-not-following-the-best-practices-dbatools-and-Pester-dont-lie%2F" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i><span>Share on Linkedin</span></a></li></ul></div><div id=share-options-mask class=share-options-mask></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-times"></i></div><img id=about-card-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"><h4 id=about-card-name>Cláudio Silva</h4><div id=about-card-bio>Data Platform Architect and PowerShell lover.</div><div id=about-card-job><i class="fa fa-briefcase"></i><br>Data Platform Architect</div><div id=about-card-location><i class="fa fa-map-marker-alt"></i><br>Portugal</div></div></div><div id=cover style=background-image:url(https://claudioessilva.eu/images/cover_bridge.jpg)></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://claudioessilva.eu/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js></script>
<script>$(document).ready(function(){hljs.configure({classPrefix:"",useBR:!1}),$("pre.code-highlight > code, pre > code").each(function(e,t){$(this).hasClass("codeblock")||$(this).addClass("codeblock"),hljs.highlightBlock(t)})})</script></body></html>