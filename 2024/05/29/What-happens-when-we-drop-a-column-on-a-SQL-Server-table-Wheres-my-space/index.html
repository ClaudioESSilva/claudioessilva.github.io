<!doctype html><html lang=en-us><head><script type=application/ld+json>{"@context":"http://schema.org","@type":"Website","@id":"https:\/\/claudioessilva.eu\/","author":{"@type":"Person","name":"Cláudio Silva","image":"https://claudioessilva.eu/img/avatar.jpg"},"name":"Cláudio Silva\u0027s Blog","description":"This article was initially posted on SQLServerCentral @ 2024-04-26.\nShort answer: The column is marked as \u0026lsquo;deleted\u0026rsquo; and will stop being visible\/usable.\nBut, most importantly - The record\/table size will remain unchanged.\nA metadata operation Dropping a column is a metadata\/logical operation, not a physical one. This means that the data isn\u0026rsquo;t removed\/overwritten by this action. As Paul Randal mentions here :\n\u0026ldquo;the cost of that will be deferred for the inserters and not for the deleters\u0026rdquo;.","url":"https:\/\/claudioessilva.eu\/2024\/05\/29\/What-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space\/","keywords":"[]"}</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo 0.126.1 with theme Tranquilpeak 0.5.3-BETA"><meta name=author content="Cláudio Silva"><meta name=keywords content><meta name=description content="This article was initially posted on SQLServerCentral @ 2024-04-26.
Short answer: The column is marked as &lsquo;deleted&rsquo; and will stop being visible/usable.
But, most importantly - The record/table size will remain unchanged.
A metadata operation Dropping a column is a metadata/logical operation, not a physical one. This means that the data isn&rsquo;t removed/overwritten by this action. As Paul Randal mentions here :
&ldquo;the cost of that will be deferred for the inserters and not for the deleters&rdquo;."><meta property="og:description" content="This article was initially posted on SQLServerCentral @ 2024-04-26.
Short answer: The column is marked as &lsquo;deleted&rsquo; and will stop being visible/usable.
But, most importantly - The record/table size will remain unchanged.
A metadata operation Dropping a column is a metadata/logical operation, not a physical one. This means that the data isn&rsquo;t removed/overwritten by this action. As Paul Randal mentions here :
&ldquo;the cost of that will be deferred for the inserters and not for the deleters&rdquo;."><meta property="og:type" content="article"><meta property="og:title" content="What happens when we drop a column on a SQL Server table? Where's my space?"><meta name=twitter:title content="What happens when we drop a column on a SQL Server table? Where's my space?"><meta property="og:url" content="https://claudioessilva.eu/2024/05/29/What-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space/"><meta property="twitter:url" content="https://claudioessilva.eu/2024/05/29/What-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space/"><meta property="og:site_name" content="Cláudio Silva's Blog"><meta property="og:description" content="This article was initially posted on SQLServerCentral @ 2024-04-26.
Short answer: The column is marked as &lsquo;deleted&rsquo; and will stop being visible/usable.
But, most importantly - The record/table size will remain unchanged.
A metadata operation Dropping a column is a metadata/logical operation, not a physical one. This means that the data isn&rsquo;t removed/overwritten by this action. As Paul Randal mentions here :
&ldquo;the cost of that will be deferred for the inserters and not for the deleters&rdquo;."><meta name=twitter:description content="This article was initially posted on SQLServerCentral @ 2024-04-26.
Short answer: The column is marked as &lsquo;deleted&rsquo; and will stop being visible/usable.
But, most importantly - The record/table size will remain unchanged.
A metadata operation Dropping a column is a metadata/logical operation, not a physical one. This means that the data isn&rsquo;t removed/overwritten by this action. As Paul Randal mentions here :
&ldquo;the cost of that will be deferred for the inserters and not for the deleters&rdquo;."><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2024-05-29T11:00:00"><meta property="article:modified_time" content="2024-05-29T11:00:00"><meta property="article:tag" content="SQLServer"><meta property="article:tag" content="TSQL"><meta property="article:tag" content="DBA"><meta property="article:tag" content="Internals"><meta property="article:tag" content="Table Structure"><meta property="article:tag" content="DBCC IND"><meta property="article:tag" content="DBCC PAGE"><meta property="article:tag" content="syndicated"><meta name=twitter:card content="summary"><meta name=twitter:site content="@claudioessilva"><meta name=twitter:creator content="@claudioessilva"><meta property="og:image" content="https://claudioessilva.eu/img/2024/0301/TableInternals_droppedColumn_CoverImage.png"><meta property="twitter:image" content="https://claudioessilva.eu/img/2024/0301/TableInternals_droppedColumn_CoverImage.png"><meta property="og:image" content="https://claudioessilva.eu/img/2024/0301/TableInternals_droppedColumn_CoverImage.png"><meta property="twitter:image" content="https://claudioessilva.eu/img/2024/0301/TableInternals_droppedColumn_CoverImage.png"><meta property="og:image" content="https://claudioessilva.eu/img/2024/0301/TableInternals_droppedColumn.png"><meta property="twitter:image" content="https://claudioessilva.eu/img/2024/0301/TableInternals_droppedColumn.png"><title>What happens when we drop a column on a SQL Server table? Where's my space?</title>
<link rel=icon href=https://claudioessilva.eu/img/favicon.jpg><link rel=canonical href=https://claudioessilva.eu/2024/05/29/What-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://claudioessilva.eu/css/style-h6ccsoet3mzkbb0wngshlfbaweimexgqcxj0h5hu4h82olsdzz6wmqdkajm.min.css></head><body><div id=blog><header id=header data-behavior=4><i id=btn-open-sidebar class="fa fa-lg fa-bars"></i><div class=header-title><a class=header-title-link href=/ aria-label="Go to homepage">Cláudio Silva's Blog</a></div><a class=header-right-picture href=/#about aria-label="Open the link: /#about"><img class=header-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a></header><nav id=sidebar data-behavior=4><div class=sidebar-container><div class=sidebar-profile><a href=/#about aria-label="Read more about the author"><img class=sidebar-profile-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"></a><h4 class=sidebar-profile-name>Cláudio Silva</h4><h5 class=sidebar-profile-bio>Data Platform Architect and PowerShell lover.</h5></div><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/ title=Home><i class="sidebar-button-icon fas fa-lg fa-home" aria-hidden=true></i>
<span class=sidebar-button-desc>Home</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/tags title=Tags><i class="sidebar-button-icon fas fa-lg fa-tags" aria-hidden=true></i>
<span class=sidebar-button-desc>Tags</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=/#about title=About><i class="sidebar-button-icon fas fa-lg fa-question" aria-hidden=true></i>
<span class=sidebar-button-desc>About</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=https://github.com/claudioessilva target=_blank rel=noopener title=GitHub><i class="sidebar-button-icon fab fa-lg fa-github" aria-hidden=true></i>
<span class=sidebar-button-desc>GitHub</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://twitter.com/claudioessilva target=_blank rel=noopener title=Twitter><i class="sidebar-button-icon fab fa-lg fa-twitter" aria-hidden=true></i>
<span class=sidebar-button-desc>Twitter</span></a></li><li class=sidebar-button><a class=sidebar-button-link href=https://www.linkedin.com/in/claudioessilva target=_blank rel=noopener title=LinkedIn><i class="sidebar-button-icon fab fa-lg fa-linkedin" aria-hidden=true></i>
<span class=sidebar-button-desc>LinkedIn</span></a></li></ul><ul class=sidebar-buttons><li class=sidebar-button><a class=sidebar-button-link href=/index.xml title=RSS><i class="sidebar-button-icon fas fa-lg fa-rss" aria-hidden=true></i>
<span class=sidebar-button-desc>RSS</span></a></li></ul></div><div class=sidebar-container><div style=color:#ebebeb;font-size:25px;text-align:center>dbatools book</div><div style=color:#ebebeb;font-size:15px>Now available! Buy it at manning.com - 50% off with code bldbatools50</div><a href="https://www.manning.com/books/learn-dbatools-in-a-month-of-lunches?utm_source=claudioessilva&utm_medium=affiliate&utm_campaign=affiliate&a_aid=claudioessilva" target=_blank><center><img src=https://images.manning.com/264/352/resize/book/0/998b76f-982a-4661-a020-5d94909f7ea5/LeMaire-HI.png height=300></center></a></div></nav><div class="post-header-cover
text-center" style=background-image:url(/img/2024/0301/TableInternals_droppedColumn_CoverImage.png);height:30% data-behavior=4></div><div id=main data-behavior=4 class="hasCover
hasCoverMetaOut"><article class=post id=top><div class="post-header main-content-wrap text-center"><h1 class=post-title>What happens when we drop a column on a SQL Server table? Where's my space?</h1><div class="postShorten-meta post-meta"><time datetime=2024-05-29T11:00:00Z>May 29, 2024</time></div></div><div class="post-content markdown"><div class=main-content-wrap><blockquote><p>This article was initially posted on <a href=https://www.sqlservercentral.com/articles/what-happens-when-we-drop-a-column-on-a-sql-server-table-wheres-my-space target=_blank rel="noopener noreferrer">SQLServerCentral
</a>@ 2024-04-26.</p></blockquote><p>Short answer: The column is marked as &lsquo;deleted&rsquo; and will stop being visible/usable.<br>But, most importantly - <strong>The record/table size will remain unchanged</strong>.</p><h1 id=a-metadata-operation>A metadata operation</h1><p>Dropping a column is a metadata/logical operation, not a physical one. This means that the data isn&rsquo;t removed/overwritten by this action.
As Paul Randal mentions <a href=%28https://www.sqlskills.com/blogs/paul/inside-the-storage-engine-anatomy-of-a-page/%29>here
</a>:</p><blockquote><p>&ldquo;the cost of that will be deferred for the inserters and not for the deleters&rdquo;.</p></blockquote><h2 id=does-that-mean-that-the-content-is-still-visible>Does that mean that the content is still visible?</h2><p>Sort of. If you try to query the table, because the metadata of the table no longer knows of its existence, you can&rsquo;t query that column and therefore you don&rsquo;t see data.</p><p>However, if we inspect the contents of a data page we may be able to still see some metadata from the column that we just dropped.<br>We can see that there was a column on a specific <code>Offset</code> that occupies <code>Length (physical) X</code> (where &lsquo;X&rsquo; is the number of bytes) is now <code>DROPPED</code>.</p><figure><a href=/img/2024/0301/TableInternals_droppedColumn.png><img src=/img/2024/0301/TableInternals_droppedColumn.png alt="Inside the page after column dropped"></a></figure><h3 id=metadata-isnt-the-data>&ldquo;Metadata isn&rsquo;t &rsquo;the&rsquo; data&rdquo;</h3><p>That&rsquo;s correct. What I found is that if you test this with a <code>(n)varchar</code> / <code>(n)char</code> data type you will still be able to see which text was on the column/record by inspecting the page.</p><p>Back to the main idea of this post, let&rsquo;s see how we can prove that space-wise nothing changes.</p><h2 id=seeing-is-believing---prepare-the-environment>Seeing is believing - prepare the environment</h2><p>To play around and see some interesting data let&rsquo;s set up a database named <code>TableInternals</code> and create a table named <code>Client</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>DATABASE</span> TableInternals
</span></span><span style=display:flex><span><span style=color:#66d9ef>GO</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>USE TableInternals
</span></span><span style=display:flex><span><span style=color:#66d9ef>GO</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> Client
</span></span><span style=display:flex><span><span style=color:#66d9ef>GO</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> Client
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>	Id			int <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>identity</span>(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>	FirstName	varchar(<span style=color:#ae81ff>50</span>),
</span></span><span style=display:flex><span>	DoB			datetime
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>GO</span>
</span></span></code></pre></div><h3 id=now-lets-insert-50000-records>Now let&rsquo;s insert 50,000 records</h3><p>The data we are going to insert will be all equal, in this case, it does not have to make sense, so I chose <code>Alex</code> for the <code>Name</code> and a <code>1900-01-01</code> for a <code>DoB</code> (Date of Birth) columns.</p><p>For that, I will use a query that relies on a bunch of CTEs to generate more records easily.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span>;<span style=color:#66d9ef>WITH</span>
</span></span><span style=display:flex><span>    L0 <span style=color:#66d9ef>AS</span> ( <span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>c</span> 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>VALUES</span>(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>                        (<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>),(<span style=color:#ae81ff>1</span>)) <span style=color:#66d9ef>AS</span> D(<span style=color:#66d9ef>c</span>) ),
</span></span><span style=display:flex><span>    L1 <span style=color:#66d9ef>AS</span> ( <span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>c</span> <span style=color:#66d9ef>FROM</span> L0 <span style=color:#66d9ef>AS</span> A <span style=color:#66d9ef>CROSS</span> <span style=color:#66d9ef>JOIN</span> L0 <span style=color:#66d9ef>AS</span> B ),
</span></span><span style=display:flex><span>    L2 <span style=color:#66d9ef>AS</span> ( <span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>c</span> <span style=color:#66d9ef>FROM</span> L1 <span style=color:#66d9ef>AS</span> A <span style=color:#66d9ef>CROSS</span> <span style=color:#66d9ef>JOIN</span> L1 <span style=color:#66d9ef>AS</span> B ),
</span></span><span style=display:flex><span>    L3 <span style=color:#66d9ef>AS</span> ( <span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>c</span> <span style=color:#66d9ef>FROM</span> L2 <span style=color:#66d9ef>AS</span> A <span style=color:#66d9ef>CROSS</span> <span style=color:#66d9ef>JOIN</span> L2 <span style=color:#66d9ef>AS</span> B ),
</span></span><span style=display:flex><span>    Nums <span style=color:#66d9ef>AS</span> ( <span style=color:#66d9ef>SELECT</span> ROW_NUMBER() OVER(<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>NULL</span>)) <span style=color:#66d9ef>AS</span> rownum
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>FROM</span> L3 
</span></span><span style=display:flex><span>			)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> Client (FirstName, DoB)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>SELECT</span> TOP (<span style=color:#ae81ff>50000</span>) <span style=color:#e6db74>&#39;Alex&#39;</span>, <span style=color:#e6db74>&#39;1900-01-01&#39;</span>
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>FROM</span> Nums
</span></span><span style=display:flex><span><span style=color:#66d9ef>GO</span>
</span></span></code></pre></div><h3 id=the-size-of-our-table>The size of our table</h3><p>To have an idea and so we can compare it with later actions, let&rsquo;s just check what is the current data size of this table right after being created.
For that let&rsquo;s use <code>sp_spaceused</code> system stored procedure</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span>sp_spaceused Client
</span></span></code></pre></div><figure class=center><img src=/img/2024/0301/TableInternals_spaceused_newTable.png alt=sp_spaceused></figure><p>We have <code>1440 KB</code> of data pages meaning 180 pages (each page has 8KB).</p><h2 id=how-to-find-a-data-page>How to find a data page?</h2><p>To be able to check the content of a page we first need a way to find which pages are allocated to a specific table. </p><p>For that, we can either use the <code>DBCC IND</code> command - which isn&rsquo;t officially documented:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#75715e>-- The syntax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>DBCC IND (database_name, <span style=color:#66d9ef>table_name</span>, index_id);
</span></span></code></pre></div><p>or, since SQL Server 2012 you can also use the - still undocumented - <code>sys.dm_db_database_page_allocations</code> dynamic management function (DMF). </p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#75715e>-- The syntax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> sys.dm_db_database_page_allocations(<span style=color:#f92672>@</span>DatabaseId, <span style=color:#f92672>@</span>TableId, <span style=color:#f92672>@</span>IndexId, <span style=color:#f92672>@</span>PartionId, <span style=color:#f92672>@</span><span style=color:#66d9ef>Mode</span>)
</span></span></code></pre></div><blockquote><p>Just a quick reminder that undocumented commands should be used with caution, as they are not officially supported by Microsoft and could potentially cause issues in your database.</p></blockquote><h3 id=examples-for-the-win>Examples for the win</h3><p>Using our example let&rsquo;s run the following T-SQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#75715e>-- Old way to see page allocations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>DBCC IND (<span style=color:#e6db74>&#39;TableInternals&#39;</span>, <span style=color:#e6db74>&#39;Client&#39;</span>, <span style=color:#ae81ff>1</span>);
</span></span></code></pre></div><p><a href=/img/2024/0301/TableInternals_DBCC_IND_Output.png><img src=/img/2024/0301/TableInternals_DBCC_IND_Output.png alt="DBCC IND output example"></a></p><p>Or as mentioned before you can also use</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#75715e>-- 2012 or newer and with more information
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> sys.dm_db_database_page_allocations(DB_ID(), OBJECT_ID(<span style=color:#e6db74>&#39;dbo.Client&#39;</span>), <span style=color:#66d9ef>NULL</span>, <span style=color:#66d9ef>NULL</span>, <span style=color:#e6db74>&#39;DETAILED&#39;</span>)
</span></span></code></pre></div><p><a href=/img/2024/0301/TableInternals_dm_db_database_page_allocations_Output.png><img src=/img/2024/0301/TableInternals_dm_db_database_page_allocations_Output.png alt="sys.dm_db_database_page_allocations output example"></a></p><p>The most attentive readers will have noticed that the output of this DMF returned 185 rows (the output of DBCC IND only returns 181.).<br>This means 185 pages are assigned to this table. &ldquo;Cláudio, but you mentioned before just 180 pages, right?&rdquo; - correct, 180 <code>DATA</code> pages. In this case, the other 5 pages are divided as follows:</p><ul><li>4 pages assigned but still unused - Link to the <code>unused</code> space. 4 pages x 8 KB = <code>32 KB</code>.</li><li>1 page - the <code>IAM_PAGE</code> that is shown in the <code>index_size</code> even that technically isn&rsquo;t an index.</li></ul><p><strong>Note:</strong> As you can see, the number of columns in the results is a bit different, with the new method retrieving more columns/data compared with <code>DBCC IND</code>.</p><h2 id=checking-the-contents-of-a-data-page>Checking the contents of a data page</h2><p>Now that we can see some pages of type <code>DATA_PAGE</code> (<code>PageType = 1</code> on the <code>DBCC IND</code> output or <code>page_type = 1</code> for the DMF) and their IDs (Note that the page IDs returned may differ on your server), let&rsquo;s pick one and pass it to a new command.</p><p>In this case, we need to use the <code>DBCC PAGE</code> command. 
This is another undocumented command. The syntax is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span>DBCC PAGE ( <span style=color:#960050;background-color:#1e0010>{‘</span>dbname<span style=color:#960050;background-color:#1e0010>’</span> <span style=color:#f92672>|</span> dbid<span style=color:#960050;background-color:#1e0010>}</span>, filenum, pagenum [, printopt<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>0</span><span style=color:#f92672>|</span><span style=color:#ae81ff>1</span><span style=color:#f92672>|</span><span style=color:#ae81ff>2</span><span style=color:#f92672>|</span><span style=color:#ae81ff>3</span><span style=color:#960050;background-color:#1e0010>}</span> ])
</span></span></code></pre></div><blockquote><p>If you want to know more about this command head to the great post <a href=https://www.sqlskills.com/blogs/paul/inside-the-storage-engine-using-dbcc-page-and-dbcc-ind-to-find-out-if-page-splits-ever-roll-back/ target=_blank rel="noopener noreferrer">Inside the Storage Engine: Using DBCC PAGE and DBCC IND to find out if page splits ever roll back
</a>and to understand the results check the post <a href=https://www.sqlskills.com/blogs/paul/inside-the-storage-engine-anatomy-of-a-page/ target=_blank rel="noopener noreferrer">Inside the Storage Engine: Anatomy of a page
</a>post both from <a href=https://www.sqlskills.com/blogs/paul target=_blank rel="noopener noreferrer">Paul Randal
</a>.</p></blockquote><h3 id=continuing-with-our-example>Continuing with our example</h3><p>By running the following T-SQL we will be able to get a dump of the data page to the console</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span>DBCC TRACEON (<span style=color:#ae81ff>3604</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>GO</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DBCC PAGE (<span style=color:#e6db74>&#39;TableInternals&#39;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>544</span>, <span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>GO</span>
</span></span></code></pre></div><p>The traceflag <code>3604</code> is to make the output of <code>DBCC PAGE</code> go to the console, rather than to the error log.
On the <code>DBCC PAGE</code> parameters, the <code>printopt=3</code> means we will get the <code>page header plus detailed per-row interpretation</code>.</p><p>If we scroll on the results we will find the values of each column in the record. </p><p><a href=/img/2024/0301/TableInternals_DBCC_PAGE_3_ColumnValues.png><img src=/img/2024/0301/TableInternals_DBCC_PAGE_3_ColumnValues.png alt="DBCC PAGE 3 Output example"></a></p><blockquote><p>NOTE: There is also a DMF that can return some of the information about a page in the database. If we are using SQL Server 2019 or a later version the <code>sys.dm_db_page_info</code> DMF gives you page header information (but not the contents/records within the page). This one is documented and is currently supported! Check it here: <a href=https://learn.microsoft.com/en-us/sql/relational-databases/system-dynamic-management-views/sys-dm-db-page-info-transact-sql target=_blank rel="noopener noreferrer">sys.dm_db_page_info (Transact-SQL)</a></p></blockquote><h2 id=dropping-the-column>Dropping the column</h2><p>Now, let&rsquo;s drop the <code>DoB</code> column</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> Client
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>COLUMN</span> DoB
</span></span><span style=display:flex><span><span style=color:#66d9ef>GO</span>
</span></span></code></pre></div><h3 id=what-is-the-actual-data-size>What is the actual data size?</h3><p>We have just dropped a column that occupies 8 bytes per record. As we have 50,000 records on the table we should get some space back, right?
Negative!</p><p>If you run again the <code>sp_spaceused</code> command you will find that nothing changed</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span>sp_spaceused Client
</span></span></code></pre></div><figure class=center><img src=/img/2024/0301/TableInternals_spaceused_newTable.png alt="sp_spaceused same picture as before because nothing changes"></figure><p>We still see the same 1,440 KB of data.</p><h3 id=what-changed-on-the-content-of-the-page>What changed on the content of the page?</h3><p>Let&rsquo;s dump the content of the same page again to check what changed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span>DBCC TRACEON (<span style=color:#ae81ff>3604</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>GO</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DBCC PAGE (<span style=color:#e6db74>&#39;TableInternals&#39;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>544</span>, <span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>GO</span>
</span></span></code></pre></div><p>This is what we get:</p><p><a href=/img/2024/0301/TableInternals_DBCC_PAGE_3_AfterDrop.png><img src=/img/2024/0301/TableInternals_DBCC_PAGE_3_AfterDrop.png alt="DBCC PAGE 3 Output example after dropping a column"></a></p><p>As I have mentioned before, we can now see that we had a column in a specific offset <code>0x8</code> which now has <code>Length 0</code> but the <code>Length (physical) 8</code> and what was before a <code>column name = datetime value</code> is now <code>DROPPED = NULL</code>.</p><h1 id=how-can-we-reclaim-the-space>How can we reclaim the space?</h1><p>The answer is simple, however, being able to do it can be a different story.</p><p>But let&rsquo;s start with the answer. Rebuild. Yes, you will need to rebuild the table/index to clear that space that is marked to be re-utilized.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#75715e>-- Let&#39;s clear the dropped column and tidy up things
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> Client REBUILD 
</span></span></code></pre></div><p>And now, if we check the space used again we can see a difference.</p><p>For that, we need to run again the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span>sp_spaceused Client
</span></span></code></pre></div><figure class=center><img src=/img/2024/0301/TableInternals_spaceused_afterDropAndRebuild.png alt="sp_spaceused after table rebuild"></figure><p>This shows that we have recovered <code>400 KB</code> of data meaning 50 pages less.</p><h3 id=why-it-may-be-not-so-easy-to-do-it>Why it may be not so easy to do it?</h3><p>This is more of a heads-up when working with big tables and/or small downtime windows.</p><p>There aren&rsquo;t free lunches! Depending on the version/edition of SQL Server being used this action can take longer than expected.</p><p>If you are working on a Standard Edition remember that you can&rsquo;t create/rebuild indexes with the <code>ONLINE=ON</code> and this operation is single-thread (no parallelism).</p><p>On the other hand, if you are working on an Enterprise Edition, you can use <code>ONLINE=ON</code> and parallelism but be aware that doing the online operation can/will require more transaction log space. If you are working with SQL Server 2017+ I recommend taking a look at <a href="https://learn.microsoft.com/en-us/sql/relational-databases/indexes/guidelines-for-online-index-operations?view=sql-server-ver16#resumable-index-considerations" target=_blank rel="noopener noreferrer">Resumable Index
</a>because it:</p><blockquote><p>Enables truncation of transaction logs during an index create or rebuild operation.</p></blockquote><h2 id=wrap-up>Wrap Up</h2><p>In this article, we saw how to use some undocumented commands in T-SQL to be able to see the contents of a data page.
We then, walk through what happens when a column is dropped and why we don&rsquo;t see any space being reclaimed by that action.
Finally, we saw how you can reclaim that space.</p><p>This just covers HEAP or CLUSTERED tables, we didn&rsquo;t cover all scenarios, here are some for you to explore:</p><ul><li>Data types that write on <code>ROW_OVERFLOW_DATA</code> or <code>LOB_DATA</code> allocations.</li><li>NONCLUSTERED indexes</li></ul><p>Thanks for reading</p></div></div><div id=post-footer class="post-footer main-content-wrap"><div class=post-footer-tags><span class="text-color-light text-small">TAGGED IN</span><br><a class="tag tag--primary tag--small" href=/tags/SQLServer/>SQLServer</a>
<a class="tag tag--primary tag--small" href=/tags/TSQL/>TSQL</a>
<a class="tag tag--primary tag--small" href=/tags/DBA/>DBA</a>
<a class="tag tag--primary tag--small" href=/tags/Internals/>Internals</a>
<a class="tag tag--primary tag--small" href=/tags/Table-Structure/>Table Structure</a>
<a class="tag tag--primary tag--small" href=/tags/DBCC-IND/>DBCC IND</a>
<a class="tag tag--primary tag--small" href=/tags/DBCC-PAGE/>DBCC PAGE</a>
<a class="tag tag--primary tag--small" href=/tags/syndicated/>syndicated</a></div><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--disabled"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2024/05/02/Check-Azure-SQL-DB-Space-Used/ data-tooltip="Check Azure SQL DB Space Used" aria-label="PREVIOUS: Check Azure SQL DB Space Used"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2024/05/29/What-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2024/05/29/What-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2024/05/29/What-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div><div class=comments><script src=https://utteranc.es/client.js repo=ClaudioESSilva/blog-comments issue-term=og:title theme=github-light crossorigin=anonymous async></script></div></div></article><footer id=footer class=main-content-wrap><span class=copyrights>&copy; 2024 Cláudio Silva. All Rights Reserved</span></footer></div><div id=bottom-bar class=post-bottom-bar data-behavior=4><div class=post-actions-wrap><nav><ul class="post-actions post-action-nav"><li class=post-action><a class="post-action-btn btn btn--disabled"><i class="fa fa-angle-left"></i>
<span class="hide-xs hide-sm text-small icon-ml">NEXT</span></a></li><li class=post-action><a class="post-action-btn btn btn--default tooltip--top" href=/2024/05/02/Check-Azure-SQL-DB-Space-Used/ data-tooltip="Check Azure SQL DB Space Used" aria-label="PREVIOUS: Check Azure SQL DB Space Used"><span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
<i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href=#btn-open-shareoptions aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.facebook.com/sharer/sharer.php?u=https://claudioessilva.eu/2024/05/29/What-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://twitter.com/intent/tweet?text=https://claudioessilva.eu/2024/05/29/What-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https://claudioessilva.eu/2024/05/29/What-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space/" title="Share on Linkedin" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li class=post-action><a class="post-action-btn btn btn--default" href=#top aria-label="Back to top"><i class="fa fa-arrow-up" aria-hidden=true></i></a></li></ul></div></div><div id=share-options-bar class=share-options-bar data-behavior=4><i id=btn-close-shareoptions class="fa fa-times"></i><ul class=share-options><li class=share-option><a class=share-option-btn target=new href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fclaudioessilva.eu%2F2024%2F05%2F29%2FWhat-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space%2F" aria-label="Share on Facebook"><i class="fab fa-facebook-square" aria-hidden=true></i><span>Share on Facebook</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fclaudioessilva.eu%2F2024%2F05%2F29%2FWhat-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space%2F" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden=true></i><span>Share on Twitter</span></a></li><li class=share-option><a class=share-option-btn target=new href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fclaudioessilva.eu%2F2024%2F05%2F29%2FWhat-happens-when-we-drop-a-column-on-a-SQL-Server-table-Wheres-my-space%2F" aria-label="Share on Linkedin"><i class="fab fa-linkedin" aria-hidden=true></i><span>Share on Linkedin</span></a></li></ul></div><div id=share-options-mask class=share-options-mask></div></div><div id=about><div id=about-card><div id=about-btn-close><i class="fa fa-times"></i></div><img id=about-card-picture src=https://claudioessilva.eu/img/avatar.jpg alt="Author's picture"><h4 id=about-card-name>Cláudio Silva</h4><div id=about-card-bio>Data Platform Architect and PowerShell lover.</div><div id=about-card-job><i class="fa fa-briefcase"></i><br>Data Platform Architect</div><div id=about-card-location><i class="fa fa-map-marker-alt"></i><br>Portugal</div></div></div><div id=cover style=background-image:url(https://claudioessilva.eu/images/cover_bridge.jpg)></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://claudioessilva.eu/js/script-yqzy9wdlzix4lbbwdnzvwx3egsne77earqmn73v9uno8aupuph8wfguccut.min.js></script><script>$(document).ready(function(){hljs.configure({classPrefix:"",useBR:!1}),$("pre.code-highlight > code, pre > code").each(function(e,t){$(this).hasClass("codeblock")||$(this).addClass("codeblock"),hljs.highlightBlock(t)})})</script></body></html>